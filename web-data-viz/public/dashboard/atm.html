<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/imgs/blackscreenicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlackScreen | ATMs</title>

    <link rel="stylesheet" href="./../css/dashboards.css">
    <link rel="stylesheet" href="./../css/dashboardAtm.css">
    <link rel="stylesheet" href="./../css/dashboardFunc.css">
    <link rel="stylesheet" href="./../css/estilo.css" />
    <script src="../js/sessao.js"></script>
    <script src="./../js/alerta.js"></script>

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=account_circle,add,close,edit,health_and_safety,home,local_atm,notifications,remove,search,search_insights" />
    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
    
    <style>
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modalContainer {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        .closeModal {
            position: absolute;
            top: 15px;
            right: 15px;
            cursor: pointer;
            color: #e74c3c;
        }
        .acao {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        .btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }
        .btn.editar {
            color: #3498db;
        }
        .btn.inativar {
            color: #e74c3c;
        }
    </style>
</head>

<body>

    <div class="janela">
<div class="header-left">
            <img src="../assets/imgs/blackscreenlogo.png" alt="BlackScreen">

            <div class="hello">
                <h3>Bem vindo, <br><span id="b_usuario">usuário</span>!</h3>
            </div>

            <div class="links">
                <div class="btn-nav-white">
                    <a href="dashboard.html">
                        <span class="material-symbols-outlined">
                            home
                        </span>
                        <h3>
                            Ínicio
                        </h3>
                    </a>
                </div>
    
                <div class="btn-nav-white">
                    <a href="./logAlertas.html">
                        <span class="material-symbols-outlined">
                            notifications
                        </span>
                        <h3>
                            Alertas
                        </h3>
                    </a>
                </div>

                <div class="btn-nav">
                    <a href="atm.html">
                        <span class="material-symbols-outlined">
                            local_atm
                        </span>
                        <h3>
                            ATMs
                        </h3>
                    </a>
                </div>

                <div class="btn-nav-white">
                    <a href="./cadastroComponentes.html">
                        <span class="material-symbols-outlined">
                            health_and_safety
                        </span>
                        <h3>
                            Componentes
                        </h3>
                    </a>
                </div>
    
                <div class="btn-nav-white">
                    <a href="./insight.html">
                        <span class="material-symbols-outlined">
                            search_insights
                        </span>
                        <h3>
                            Insights
                        </h3>
                    </a>
                </div>
    
                <div class="btn-nav-white">
                    <a href="./perfil.html">
                        <span class="material-symbols-outlined">
                            account_circle
                        </span>
                        <h3>
                            Meu Perfil
                        </h3>
                    </a>
                </div>
            </div>

            <div class="btn-logout" onclick="limparSessao()">
                <h3>Sair</h3>
            </div>

        </div>

        <div class="content">
            <div class="listaAtm">
                <div class="header">
                    <div class="pesquisa">
                        <input type="text" id="pesquisa_input" placeholder="Pesquisar ATM...">
                        <span class="material-symbols-outlined">search</span>
                    </div>
                </div>
                <div class="lista">
                    <div class="lista-header">
                        <p class="id">ID</p>
                        <p class="atm">Código ATM</p>
                        <p class="address">Endereço</p>
                        <p class="country">Cidade/UF</p>
                        <p class="alertas">Componentes</p>
                        <p class="acao">Ações</p>
                    </div>
                    <div class="lista-content">
                        <!-- ATMs serão carregados aqui -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para adicionar componentes ao ATM -->
        <div class="modal" id="modal_componentes" style="display: none;">
            <div class="modalContainer">
                <span class="material-symbols-outlined closeModal" onclick="fecharModal()">
                    close
                </span>
                <h2>Gerenciar Componentes do ATM</h2>
                <h3 id="atm_nome"></h3>
                <div class="form">
                    <div class="inputGroup">
                        <label>Associar Componente Existente</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <select id="select_componente_disponivel" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">Selecione um componente</option>
                            </select>
                            <button onclick="associarComponente()" style="padding: 8px 16px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer;">Associar</button>
                        </div>
                    </div>
                    <div class="inputGroup">
                        <label>Componentes Associados a este ATM</label>
                        <div id="componentes_associados" style="max-height: 300px; overflow-y: auto;">
                            <!-- Componentes já associados serão listados aqui -->
                        </div>
                    </div>
                    <div class="btnGroup">
                        <button class="cancel" onclick="fecharModal()">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


</body>


</html>

<script>
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    let atmsData = [];
    let componentesDisponiveis = [];
    let atmSelecionadoId = null;

    // Carregar ATMs ao iniciar
    window.onload = () => {
        carregarATMs();
    };

    function carregarATMs() {
        fetch("/caixas/listar", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "Fk_Empresa": sessionStorage.FK_EMPRESA
            }
        })
            .then(response => response.json())
            .then(data => {
                atmsData = data;
                const listaContent = document.querySelector(".lista-content");
                listaContent.innerHTML = "";
                
                if (data.length === 0) {
                    listaContent.innerHTML = "<p style='padding: 20px; text-align: center;'>Nenhum ATM cadastrado.</p>";
                    return;
                }

                data.forEach(atm => {
                    const item = document.createElement("div");
                    item.classList.add("lista-item");
                    
                    const endereco = `${atm.Logradouro}, ${atm.Bairro}`;
                    const cidadeUF = `${atm.Cidade}/${atm.UF}`;
                    
                    item.innerHTML = `
                        <p class="id">${atm.id}</p>
                        <p class="atm">${atm.codigoCaixa}</p>
                        <p class="address">${endereco}</p>
                        <p class="country">${cidadeUF}</p>
                        <p class="alertas" id="comp_count_${atm.id}">-</p>
                        <p class="acao">
                            <button class="btn editar material-symbols-outlined" title="Gerenciar Componentes" onclick="abrirModalComponentes(${atm.id}, '${atm.codigoCaixa}')">health_and_safety</button>
                        </p>
                    `;
                    listaContent.appendChild(item);
                    
                    // Carregar quantidade de componentes
                    carregarQtdComponentes(atm.id);
                });
            })
            .catch(error => {
                console.error("Erro ao carregar ATMs:", error);
            });
    }

    function carregarQtdComponentes(idCaixa) {
        fetch(`/componentes/listar-por-caixa/${idCaixa}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(response => response.json())
            .then(data => {
                const elemento = document.getElementById(`comp_count_${idCaixa}`);
                if (elemento) {
                    elemento.textContent = data.length;
                }
            })
            .catch(error => {
                console.error("Erro ao carregar componentes:", error);
                const elemento = document.getElementById(`comp_count_${idCaixa}`);
                if (elemento) {
                    elemento.textContent = "0";
                }
            });
    }

    function abrirModalComponentes(idCaixa, codigoCaixa) {
        atmSelecionadoId = idCaixa;
        document.getElementById("atm_nome").textContent = `ATM: ${codigoCaixa}`;
        document.getElementById("modal_componentes").style.display = "flex";
        
        carregarComponentesDisponiveis();
        carregarComponentesAssociados(idCaixa);
    }

    function carregarComponentesDisponiveis() {
        fetch("/componentes/listar", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "Fk_Empresa": sessionStorage.FK_EMPRESA
            }
        })
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById("select_componente_disponivel");
                select.innerHTML = '<option value="">Selecione um componente</option>';
                
                // Filtrar componentes que não estão associados ao ATM atual
                const componentesDisponiveis = data.filter(c => {
                    if (!c.Caixas_Ids) return true; // Componente sem ATM
                    const caixasArray = c.Caixas_Ids.split(',');
                    return !caixasArray.includes(String(atmSelecionadoId));
                });
                
                if (componentesDisponiveis.length === 0) {
                    select.innerHTML = '<option value="">Nenhum componente disponível</option>';
                    return;
                }
                
                componentesDisponiveis.forEach(comp => {
                    const option = document.createElement("option");
                    option.value = comp.Id_Componente;
                    const atmsInfo = comp.Caixas_Codigos ? ` (ATMs: ${comp.Caixas_Codigos})` : ' (Sem ATM)';
                    option.textContent = `${comp.Nome_Componente} - ${comp.Unidade || 'N/A'}${atmsInfo}`;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error("Erro ao carregar componentes disponíveis:", error);
            });
    }

    function associarComponente() {
        const idComponente = document.getElementById("select_componente_disponivel").value;

        if (!idComponente) {
            console.warn("Selecione um componente para associar!");
            return;
        }

        fetch("/componentes/associar-caixa", {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idComponente: parseInt(idComponente),
                idCaixa: atmSelecionadoId
            })
        })
            .then(response => {
                if (response.ok) {
                    console.log("Componente associado com sucesso!");
                    carregarComponentesDisponiveis();
                    carregarComponentesAssociados(atmSelecionadoId);
                    carregarQtdComponentes(atmSelecionadoId);
                } else {
                    return response.json().then(data => {
                        console.error("Erro ao associar componente:", data.erro || "Erro desconhecido");
                    });
                }
            })
            .catch(error => {
                console.error("Erro:", error);
            });
    }

    function carregarComponentesAssociados(idCaixa) {
        fetch(`/componentes/listar-por-caixa/${idCaixa}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById("componentes_associados");
                container.innerHTML = "";
                
                if (data.length === 0) {
                    container.innerHTML = "<p style='padding: 10px;'>Nenhum componente associado a este ATM.</p>";
                    return;
                }
                
                data.forEach(comp => {
                    const item = document.createElement("div");
                    item.style.cssText = "padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;";
                    item.innerHTML = `
                        <div>
                            <strong>${comp.Nome_Componente}</strong><br>
                            <small>Unidade: ${comp.Unidade || 'N/A'} | Parâmetro: ${comp.Valor_Parametrizado || 'N/A'}</small>
                        </div>
                        <button class="btn inativar material-symbols-outlined" title="Desassociar" onclick="desassociarComponente(${comp.Id_Componente})" style="background: none; border: none; color: #e74c3c; cursor: pointer;">remove</button>
                    `;
                    container.appendChild(item);
                });
            })
            .catch(error => {
                console.error("Erro ao carregar componentes associados:", error);
            });
    }

    function desassociarComponente(idComponente) {
        if (!confirm("Tem certeza que deseja desassociar este componente do ATM?")) {
            return;
        }
        
        fetch("/componentes/desassociar-caixa", {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idComponente: idComponente,
                idCaixa: atmSelecionadoId
            })
        })
            .then(response => {
                if (response.ok) {
                    console.log("Componente desassociado com sucesso!");
                    carregarComponentesDisponiveis();
                    carregarComponentesAssociados(atmSelecionadoId);
                    carregarQtdComponentes(atmSelecionadoId);
                } else {
                    console.error("Erro ao desassociar componente");
                }
            })
            .catch(error => {
                console.error("Erro:", error);
            });
    }

    function fecharModal() {
        document.getElementById("modal_componentes").style.display = "none";
        atmSelecionadoId = null;
        carregarATMs(); // Recarregar para atualizar contagem
    }

    // Pesquisa
    const pesquisar = document.getElementById("pesquisa_input");
    pesquisar.addEventListener("input", function () {
        const termo = this.value.toLowerCase();
        const itens = document.querySelectorAll(".lista-item");
        itens.forEach(item => {
            const atm = item.querySelector(".atm").textContent.toLowerCase();
            const address = item.querySelector(".address").textContent.toLowerCase();
            if (atm.includes(termo) || address.includes(termo)) {
                item.style.display = "";
            } else {
                item.style.display = "none";
            }
        });
    });
</script>
