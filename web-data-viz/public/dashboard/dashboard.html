<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/imgs/blackscreenicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlackScreen | Dashboards</title>
    
    <!-- CSS Originais -->
    <link rel="stylesheet" href="./../css/dashboards.css">
    <link rel="stylesheet" href="./../css/style.css" />
    <link rel="stylesheet" href="./../css/dashboardHome.css">
    <link rel="stylesheet" href="./../css/dashboardCalor.css">
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    
    <script src="../js/sessao.js"></script>
    <script src="./../js/alerta.js"></script>

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">


    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-bundle.min.js"></script>
    <script src="https://cdn.anychart.com/releases/8.11.0/geodata/custom/world/world.js"></script>
    <script src="https://cdn.anychart.com/releases/8.11.0/geodata/countries/brazil/brazil.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.15/proj4.js"></script>
    <link rel="stylesheet" href="https://cdn.anychart.com/releases/8.11.0/css/anychart-ui.min.css">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

</head>
<body>    
    <div class="janela">
        <div class="header-left">
            <img src="../assets/imgs/blackscreenlogo.png" alt="BlackScreen">

            <div class="hello">
                <h3>Bem vindo, <br><span id="b_usuario">usuário</span>!</h3>
            </div>

           <div class="links">
                <div class="btn-nav">
                    <a href="../dashboard/dashboard.html">
                        <span class="material-symbols-outlined">
                            home
                        </span>
                        <h3>
                            Ínicio
                        </h3>
                    </a>
                </div>
    
                <div class="btn-nav-white">
                    <a href="../dashboard/logAlertas.html">
                        <span class="material-symbols-outlined">
                            notifications
                        </span>
                        <h3>
                            Alertas
                        </h3>
                    </a>
                </div>

                <div class="btn-nav-white">
                    <a href="../dashboard/atm.html">
                        <span class="material-symbols-outlined">
                            local_atm
                        </span>
                        <h3>
                            ATMs
                        </h3>
                    </a>
                </div>

                <div class="btn-nav-white">
                    <a href="../dashboard/cadastroComponentes.html">
                        <span class="material-symbols-outlined">
                            health_and_safety
                        </span>
                        <h3>
                            Componentes
                        </h3>
                    </a>
                </div>
                <div class="btn-nav-white">
                    <a href="../dashLukas/persona.html">
                        <span class="material-symbols-outlined">
                            signal_cellular_alt
                        </span>
                        <h3>
                            Persona
                        </h3>
                    </a>
                </div>
                <div class="btn-nav-white">
                    <a href="./insight.html">
                        <span class="material-symbols-outlined">
                            search_insights
                        </span>
                        <h3>
                            Insights
                        </h3>
                    </a>
                </div>
                <div class="btn-nav-white">
                    <a href="./perfil.html">
                        <span class="material-symbols-outlined">
                            account_circle
                        </span>
                        <h3>
                            Meu Perfil
                        </h3>
                    </a>
                </div>
            </div>

            <div class="btn-logout" onclick="limparSessao()">
                <h3>Sair</h3>
            </div>

        </div>

        <div class="content">
            <div class="top">
                <div class="kpis expanded">
                    <div class="kpi">
                        <h3>Caixas Cadastrados</h3>
                        <h1 id="totalCaixas">178</h1>
                        <div class="status">
                            <div class="status-item">
                                <div class="circle green"></div>
                                <p>Ativos: <span id="caixasAtivos">150</span></p>
                            </div>
                            <div class="status-item">
                                <div class="circle red"></div>
                                <p>Inativos: <span id="caixasInativos">28</span></p>
                            </div>
                        </div>
                    </div>
                    <div class="kpi">
                        <h3><span>Top 3</span> ATMs Mais Alerta</h3>
                        <div class="rank">
                            <div class="header">
                                <p>N*</p><p class="atm">ATM</p><p>Alertas</p>
                            </div>
                            <div class="top3 first" id="top1MaiorAlerta">
                                <p>1*</p><p class="atm">ATM Paulista</p><p class="alertas">14</p>
                            </div>
                            <div class="top3 second" id="top2MaiorAlerta">
                                <p>2*</p><p class="atm">ATM São José</p><p class="alertas">13</p>
                            </div>
                            <div class="top3 third" id="top3MaiorAlerta">
                                <p>3*</p><p class="atm">ATM Iguatemi</p><p class="alertas">8</p>
                            </div>
                        </div>
                    </div>
                    <div class="kpi">
                        <h3><span>Top 3</span> Componentes Mais Alerta</h3>
                        <div class="rank">
                            <div class="header">
                                <p>N*</p><p class="atm">Componente</p><p>Alertas</p>
                            </div>
                            <div class="top3 first" id="top1MaiorAlerta">
                                <p>1*</p><p class="atm">CPU</p><p class="alertas">14</p>
                            </div>
                            <div class="top3 second" id="top2MaiorAlerta">
                                <p>2*</p><p class="atm">Rede</p><p class="alertas">13</p>
                            </div>
                            <div class="top3 third" id="top3MaiorAlerta">
                                <p>3*</p><p class="atm">Disco</p><p class="alertas">8</p>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn-expand-kpi material-symbols-outlined">keyboard_arrow_up</button>
    
                <div class="pesquisa-filtros">
                    <div class="pesquisa-div">
                        <input type="text" id="pesquisa" placeholder="Pesquisar..." onkeyup="">
                        <span class="material-symbols-outlined">search</span>
                    </div>
                    <select name="slt_tipo_mapa" id="select-mapa">
                        <option value="padrao">Localização</option>
                        <option value="operacionais">Mapa de Calor</option>
                    </select>
                </div>
            </div>
            <div id="map-container-wrapper">
                <div id="map"></div>
                <div id="container-anychart">
                    <button id="btn-voltar-mundo" onclick="renderWorldMap()">
                        <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 18px;">arrow_back</span> 
                        Voltar ao Mundo
                    </button>
                </div>
            </div>
        </div>
        <div id="modal">
            <div id="modalContainer">
                <div class="header" onclick="closeModal()">
                    <h1 id="caixa-name"></h1>
                    <button class="material-symbols-outlined close">close</button>
                </div>
                <div class="contentModal">
                    <div class="left">
                        <div class="item">
                            <div class="title">
                                <span class="material-symbols-outlined">location_on</span>
                                <h2>Localização</h2>
                            </div>
                            <p id="caixa-endereco">Rua Exemplo, 123 - Bairro, Cidade/UF</p>
                        </div>
                        <div class="item">
                            <div class="title">
                                <span class="material-symbols-outlined">docs</span>
                                <h2>Visão Geral</h2>
                            </div>
                            <h3>Status:</h3>
                            <p id="caixa-status" class="status ativo">
                                <span class="material-symbols-outlined">check_circle</span>
                                Ativo
                            </p>
                            <h3>Componentes:</h3>
                            <div class="components" id="component-container">
                                <p class="status bom">
                                    <span class="material-symbols-outlined">check_circle</span>
                                    Impressora de Recibos
                                </p>
                                <p class="status bom">
                                    <span class="material-symbols-outlined">check_circle</span>
                                    Teclado
                                </p>
                                <p class="status bom">
                                    <span class="material-symbols-outlined">check_circle</span>
                                    Conexão
                                </p>
                                <p class="status alerta">
                                    <span class="material-symbols-outlined">circle_notifications</span>
                                    Dispensador de Cédulas
                                </p>
                                <p class="status falha">
                                    <span class="material-symbols-outlined">do_not_disturb_on</span>
                                    Leitor de Cartão
                                </p>
                            </div>
                            <h3>Alertas Recentes:</h3>
                            <table>
                                <tr>
                                    <th>Data</th>
                                    <th>Componente</th>
                                    <th>Descrição</th>
                                </tr>
                                <tr>
                                    <td>2024-06-15 14:32</td>
                                    <td>CPU</td>
                                    <td>Uso elevado da CPU (74%)</td>
                                </tr>
                                <!-- Linhas originais mantidas -->
                            </table>
                        </div>
                    </div>
                    <div class="right">
                        <div class="title">
                            <span class="material-symbols-outlined">health_and_safety</span>
                            <h2>Saúde do Sistema</h2>
                        </div>
                        <div class="stats cpu">
                            <h3>CPU</h3>
                            <div class="progress-bar">
                                <div class="progress" style="width: 98%;"></div>
                            </div>
                            <div class="stat usoAtual">
                                <div class="circle ruim"></div>
                                <p>Uso: <span>98%</span></p>
                            </div>
                            <div class="stat tempAtual">
                                <div class="circle bom"></div>
                                <p>Temperatura: <span>55°C</span></p>
                            </div>
                            <div class="stat totalProcessos">
                                <div class="circle bom"></div>
                                <p>Total de Processos: <span>123</span></p>
                            </div>
                        </div>
                        <!-- Outras stats mantidas... -->
                    </div>
                </div>
            </div>
        </div>

        <div id="modal-ia">
            <div class="modal-ia-content">
                <div class="modal-ia-header">
                    <div>
                        <h2 id="modal-ia-title">Estado Detalhes</h2>
                        <p>Análise Preditiva e Monitoramento de Hardware</p>
                    </div>
                    <button class="btn-close-ia material-symbols-outlined" onclick="closeIaModal()">close</button>
                </div>
                <div class="modal-ia-body">
                    <div class="kpi-grid">
                        <div class="kpi-card blue">
                            <div class="kpi-label">Mediana CPU</div>
                            <div class="kpi-value" id="ia-cpu">45%</div>
                        </div>
                        <div class="kpi-card purple">
                            <div class="kpi-label">Mediana RAM</div>
                            <div class="kpi-value" id="ia-ram">8.2 GB</div>
                        </div>
                        <div class="kpi-card orange">
                            <div class="kpi-label">Mediana Disco</div>
                            <div class="kpi-value" id="ia-disk">72%</div>
                        </div>
                        <div class="kpi-card green">
                            <div class="kpi-label">Rede (I/O)</div>
                            <div class="kpi-value" id="ia-net">450 MB/s</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 style="margin-bottom: 10px; color: #333;">Previsão de Consumo (Próximas 24h)</h3>
                        <div id="chart-regression" style="width: 100%; height: 300px;"></div>
                    </div>

                    <div>
                        <h3 style="margin-bottom: 10px; color: #333;">Processos Críticos da Região</h3>
                        <div class="table-container">
                            <table class="table-ia">
                                <thead>
                                    <tr>
                                        <th>Nome do Processo</th>
                                        <th>PID</th>
                                        <th>Uso CPU</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="process-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="">
    </script>
    <script src="../js/leaflet-heat.js"></script>


    <script>
        document.querySelector('.btn-expand-kpi').addEventListener('click', function(){
            const kpis = document.querySelector('.content .kpis');
            kpis.classList.toggle('expanded');
            if (kpis.classList.contains('expanded')) {
                this.style.rotate = '0deg';
            } else {
                this.style.rotate = '180deg';
            }
        });

        function closeModal(){
            document.getElementById('modal').style.display = "none";
        }

        // --- 2. Leaflet Map (Código Original Mantido) ---
        const icon = L.icon({
            iconUrl: '../assets/imgs/marker.png',
            shadowUrl: '../assets/imgs/marker_shadow.png',
            iconSize:     [48, 95],
            shadowSize:   [50, 64],
            iconAnchor:   [22, 94],
            shadowAnchor: [0, 72],
            popupAnchor:  [-3, -76]
        });

        // ZOOM CONTROL DISABLED HERE
        const map = L.map('map', { zoomControl: false }).setView([-23.55052, -46.633308], 12);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19, attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        const fkEmpresa = sessionStorage.getItem("FK_EMPRESA");
       
        fetch('/caixas/listar', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'FK_EMPRESA': fkEmpresa
            },
        })
            .then(r => r.json())
            .then(lista => {
                const group = L.featureGroup();
                lista.forEach(c => {
                    if (c.Latitude == null || c.Longitude == null) return;

                    marker = L.marker([c.Latitude, c.Longitude], {icon: icon})
                        .bindPopup(
                            `<b>${c.codigoCaixa}</b><br>${c.Logradouro}<br>${c.Bairro} - ${c.Cidade}/${c.UF}<br> <i>Empresa dona: </i>${c.eNome}<br> <i>Código da empresa: </i> ${c.Id_Empresa}`
                        )
                        .addTo(group);
                    marker.on('mouseover',function(ev) {
                        ev.target.openPopup();
                    });
                    marker.on('mouseout',function(ev) {
                        ev.target.closePopup();
                    });
                    
                    marker.on('click', function (e){
                        document.getElementById('modal').style.display = "flex";
                        document.getElementById('caixa-name').textContent = c.codigoCaixa;
                        document.getElementById('caixa-endereco').textContent = `${c.Logradouro} - ${c.Bairro}, ${c.Cidade}/${c.UF}`;
                        statusCaixa = 1;
                        if(statusCaixa === 1){
                            document.getElementById('caixa-status').classList.remove('inativo');
                            document.getElementById('caixa-status').classList.add('ativo');
                            document.getElementById('caixa-status').innerHTML = `
                                <span class="material-symbols-outlined">check_circle</span>
                                Ativo
                            `;
                        } else {
                            document.getElementById('caixa-status').classList.remove('ativo');
                            document.getElementById('caixa-status').classList.add('inativo');
                            document.getElementById('caixa-status').innerHTML = `
                                <span class="material-symbols-outlined">cancel</span>
                                Inativo
                            `;
                        }
                    });
                });

                if (group.getLayers().length) {
                    group.addTo(map);
                    try { map.fitBounds(group.getBounds().pad(0.2)); } catch (_) { }
                }
                    // Atualizar contadores do dashboard com a lista retornada
                    try {
                        const total = lista.length;
                        let ativos = lista.filter(c => c.Ativo == 1 || c.ativo == 1 || c.status == 'Ativo' || c.status == 'ativo' || c.Status == 'ativo' || c.Status == 'Ativo').length;
                        // Se não houver informação de status no resultado, assume que todas as caixas retornadas estão ativas
                        if (ativos === 0) ativos = total;
                        const inativos = Math.max(0, total - ativos);

                        const elTotal = document.getElementById('totalCaixas');
                        const elAtivos = document.getElementById('caixasAtivos');
                        const elInativos = document.getElementById('caixasInativos');

                        if (elTotal) elTotal.textContent = total;
                        if (elAtivos) elAtivos.textContent = ativos;
                        if (elInativos) elInativos.textContent = inativos;
                    } catch (e) {
                        console.error('Erro ao atualizar contadores de caixas:', e);
                    }
            })
            .catch(err => console.error("Falha ao carregar /caixas:", err));
        


        // --- 3. Novas Funcionalidades (AnyChart + ApexCharts) ---
        let mapAnyChart;
        let chartInstance = null;
        let anyChartInitialized = false;
        let dadosBucketCache = []; // Cache para evitar requisições repetidas

        // Função para buscar dados do bucket e processar para o mapa
        async function fetchAndProcessBucketData() {
            try {
                const response = await fetch('/bucket/dashboard');
                const dados = await response.json();
                dadosBucketCache = dados;
                
                // Processar dados para o formato do AnyChart
                // Agrupar por UF
                const dadosPorEstado = {};
                
                dados.forEach(d => {
                    // O backend já retorna 'uf' cruzado com o banco
                    const uf = d.uf || 'SP'; 
                    const idMap = `BR.${uf.toUpperCase()}`;
                    
                    if (!dadosPorEstado[idMap]) {
                        dadosPorEstado[idMap] = { 
                            id: idMap, 
                            value: 0, 
                            name: uf, 
                            processos: [],
                            total: 0 
                        };
                    }
                    
                    dadosPorEstado[idMap].value += 1; // Contagem de máquinas
                    // d.dados contém o JSON do bucket
                    dadosPorEstado[idMap].processos.push(d.dados);
                });

                // Converter para array
                return Object.values(dadosPorEstado).map(estado => {
                    // Encontrar processo com maior consumo de CPU neste estado
                    let maxCpu = 0;
                    let maxProcess = "N/A";
                    
                    estado.processos.forEach(json => {
                        // Assumindo que o JSON tem uma lista de processos ou métricas
                        // Se o JSON for direto { cpu: 90, processo: 'java' }
                        const cpu = parseFloat(json.uso_cpu || json.cpu || 0);
                        if (cpu > maxCpu) {
                            maxCpu = cpu;
                            maxProcess = json.processo || json.nome || 'N/A';
                        }
                    });

                    return {
                        id: estado.id,
                        value: estado.value, // Quantidade de registros
                        name: estado.name,
                        custom_max: maxProcess,
                        total: estado.value // Total de registros
                    };
                });

            } catch (error) {
                console.error("Erro ao buscar dados para o mapa:", error);
                return [];
            }
        }

        const worldData = [
            { id: "BR", value: 950, name: "Brasil" }
        ];

        // Dados iniciais vazios, serão preenchidos pelo fetch
        let brazilData = [];

        async function initAnyChart() {
            if(anyChartInitialized) return;
            
            // Carregar dados antes de renderizar
            const dadosProcessados = await fetchAndProcessBucketData();
            if (dadosProcessados.length > 0) {
                brazilData = dadosProcessados;
            } else {
                // Fallback se não tiver dados
                brazilData = [
                    { id: "BR.SP", value: 0, name: "São Paulo", custom_max: "N/A", total: 0 }
                ];
            }

            renderWorldMap();
            anyChartInitialized = true;
        }

        function renderWorldMap() {
            document.getElementById('container-anychart').innerHTML = ''; 
            const btn = document.createElement('button');
            btn.id = 'btn-voltar-mundo';
            btn.onclick = renderWorldMap;
            btn.innerHTML = '<span class="material-symbols-outlined" style="vertical-align: middle; font-size: 18px;">arrow_back</span> Voltar ao Mundo';
            document.getElementById('container-anychart').appendChild(btn);
            btn.style.display = 'none'; 

            mapAnyChart = anychart.map();
            mapAnyChart.geoData(anychart.maps.world);
            
            var colorScale = anychart.scales.linearColor();
            colorScale.colors(['#dbeafe', '#3b82f6', '#1e40af', '#051e3e']);

            var series = mapAnyChart.choropleth(worldData);
            series.colorScale(colorScale);
            series.hovered().fill('#facc15');
            series.labels(false);
            series.tooltip().format("Máquinas: {%value}");

            mapAnyChart.listen("pointClick", function(e) {
                if(e.point.get("id") === "BR") renderBrazilMap();
            });

            if(mapAnyChart.zoomControl) {
                mapAnyChart.zoomControl().render(mapAnyChart);
            }

            mapAnyChart.container("container-anychart");
            mapAnyChart.draw();
        }

        function renderBrazilMap() {
            document.getElementById('container-anychart').innerHTML = '';
            
            const btn = document.createElement('button');
            btn.id = 'btn-voltar-mundo';
            btn.onclick = renderWorldMap;
            btn.innerHTML = '<span class="material-symbols-outlined" style="vertical-align: middle; font-size: 18px;">arrow_back</span> Voltar ao Mundo';
            btn.style.display = 'block';
            document.getElementById('container-anychart').appendChild(btn);

            mapAnyChart = anychart.map();
            mapAnyChart.geoData(anychart.maps.brazil);

            var colorScale = anychart.scales.linearColor();
            colorScale.colors(['#bfdbfe', '#2563eb', '#051e3e']);

            var series = mapAnyChart.choropleth(brazilData);
            series.colorScale(colorScale);
            series.labels(false);
            
            series.tooltip().useHtml(true);
            series.tooltip().format(function() {
                return `Máquinas: <b>${this.value}</b><br/>Maior Consumo: <b>${this.getData("custom_max")}</b>`;
            });

            mapAnyChart.listen("pointClick", function(e) {
                openIaModal(e.point.get("name"));
            });
            
             if(mapAnyChart.zoomControl) {
                mapAnyChart.zoomControl().render(mapAnyChart);
            }

            mapAnyChart.container("container-anychart");
            mapAnyChart.draw();
        }

        // --- 4. Lógica do Novo Modal IA ---
        async function openIaModal(estadoNome) {
            const modal = document.getElementById('modal-ia');
            document.getElementById('modal-ia-title').innerText = `Análise: ${estadoNome}`;
            
            // Loading state
            document.getElementById('ia-cpu').innerText = "...";
            document.getElementById('ia-ram').innerText = "...";
            document.getElementById('process-table-body').innerHTML = '<tr><td colspan="4">Carregando dados...</td></tr>';

            modal.style.display = 'flex';
            
            // Usar dados do cache se disponíveis, senão buscar
            let dados = dadosBucketCache;
            if (!dados || dados.length === 0) {
                try {
                    const response = await fetch('/bucket/dashboard');
                    dados = await response.json();
                    dadosBucketCache = dados;
                } catch (error) {
                    console.error("Erro ao buscar dados:", error);
                    return;
                }
            }

            // Filtrar dados pelo estado selecionado (estadoNome vem do mapa, ex: "São Paulo")
            // O backend retorna 'uf' (ex: SP)
            
            const dadosEstado = dados.filter(d => {
                const uf = d.uf || '';
                // Mapeamento simples: se estadoNome contém a UF ou vice-versa
                // Ex: estadoNome="São Paulo", uf="SP" -> precisamos de um mapa melhor ou assumir que o mapa retorna nomes completos
                // O AnyChart retorna nomes completos (São Paulo). O banco retorna UF (SP).
                // Vou fazer um match simples
                const mapUf = {
                    "Acre": "AC", "Alagoas": "AL", "Amapá": "AP", "Amazonas": "AM", "Bahia": "BA", "Ceará": "CE", "Distrito Federal": "DF", "Espírito Santo": "ES", "Goiás": "GO", "Maranhão": "MA", "Mato Grosso": "MT", "Mato Grosso do Sul": "MS", "Minas Gerais": "MG", "Pará": "PA", "Paraíba": "PB", "Paraná": "PR", "Pernambuco": "PE", "Piauí": "PI", "Rio de Janeiro": "RJ", "Rio Grande do Norte": "RN", "Rio Grande do Sul": "RS", "Rondônia": "RO", "Roraima": "RR", "Santa Catarina": "SC", "São Paulo": "SP", "Sergipe": "SE", "Tocantins": "TO"
                };
                
                const ufEsperada = mapUf[estadoNome] || estadoNome;
                return uf === ufEsperada;
            });

            if (dadosEstado.length === 0) {
                 document.getElementById('process-table-body').innerHTML = '<tr><td colspan="4">Nenhum dado encontrado para esta região.</td></tr>';
                 renderChart([], []);
                 return;
            }

            // Calcular KPIs reais baseados nos dados filtrados
            let totalCpu = 0;
            let totalRam = 0;
            let count = 0;
            
            dadosEstado.forEach(d => {
                const json = d.dados;
                totalCpu += parseFloat(json.uso_cpu || json.cpu || 0);
                totalRam += parseFloat(json.uso_ram || json.ram || 0);
                count++;
            });
            
            const mediaCpu = count > 0 ? (totalCpu / count).toFixed(1) : 0;
            const mediaRam = count > 0 ? (totalRam / count).toFixed(1) : 0;

            document.getElementById('ia-cpu').innerText = mediaCpu + "%";
            document.getElementById('ia-ram').innerText = mediaRam + " GB"; 
            
            const tbody = document.getElementById('process-table-body');
            tbody.innerHTML = '';

            // Exibe os top 10 processos por uso de CPU (pegando de todos os JSONs da região)
            // Assumindo que cada JSON tem um campo 'processos' que é uma lista, OU que o JSON é um processo único
            // Se for processo único, já temos a lista em dadosEstado
            
            const listaProcessos = [];
            dadosEstado.forEach(d => {
                const json = d.dados;
                // Se o JSON tiver lista de processos
                if (json.processos && Array.isArray(json.processos)) {
                    listaProcessos.push(...json.processos);
                } else {
                    // Se o JSON for o próprio processo
                    listaProcessos.push(json);
                }
            });

            listaProcessos
                .sort((a, b) => parseFloat(b.uso_cpu || b.cpu || 0) - parseFloat(a.uso_cpu || a.cpu || 0))
                .slice(0, 10)
                .forEach(p => {
                    const nome = p.processo || p.nome || 'Desconhecido';
                    const pid = p.pid || p.id || 'N/A';
                    const cpu = p.uso_cpu || p.cpu || '0';
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${nome}</td>
                        <td>${pid}</td>
                        <td><span class="badge ${parseFloat(cpu) > 10 ? 'high' : 'ok'}">${cpu}%</span></td>
                        <td>Running</td>
                    `;
                    tbody.appendChild(tr);
                });

            // Preparar dados para o gráfico (Histórico vs Predição)
            // Agrupar dados por data
            // Assumindo que d.data_arquivo existe (veio do backend)
            const dadosPorData = {};
            dadosEstado.forEach(d => {
                if (d.data_arquivo) {
                    if (!dadosPorData[d.data_arquivo]) dadosPorData[d.data_arquivo] = [];
                    dadosPorData[d.data_arquivo].push(d.dados);
                }
            });
            
            // Ordenar datas
            const datasOrdenadas = Object.keys(dadosPorData).sort();
            
            // Calcular média de CPU por dia para o histórico
            const historicoData = [];
            const historicoLabels = [];
            
            datasOrdenadas.forEach(data => {
                const lista = dadosPorData[data];
                const soma = lista.reduce((acc, item) => acc + parseFloat(item.uso_cpu || item.cpu || 0), 0);
                const media = soma / lista.length;
                historicoData.push(media.toFixed(1));
                historicoLabels.push(data.split('-').slice(1).join('/')); // MM/DD
            });

            // Simular predição (já que não temos modelo real aqui, vamos projetar a média + variação)
            // Se o JSON tiver campo 'predicao', usar ele.
            // Vou criar uma série de predição que começa no último ponto do histórico
            const predicaoData = new Array(historicoData.length).fill(null); // Null para alinhar com histórico
            
            // Adicionar ponto de conexão
            if (historicoData.length > 0) {
                const ultimoValor = parseFloat(historicoData[historicoData.length - 1]);
                predicaoData[historicoData.length - 1] = ultimoValor;
                
                // Gerar 3 dias futuros
                for (let i = 1; i <= 3; i++) {
                    const valorPrevisto = ultimoValor * (1 + (Math.random() * 0.1 - 0.05)); // Variação +/- 5%
                    predicaoData.push(valorPrevisto.toFixed(1));
                    
                    // Adicionar label futura
                    const ultimaData = new Date(datasOrdenadas[datasOrdenadas.length - 1]);
                    ultimaData.setDate(ultimaData.getDate() + i);
                    const dia = String(ultimaData.getDate()).padStart(2, '0');
                    const mes = String(ultimaData.getMonth() + 1).padStart(2, '0');
                    historicoLabels.push(`${mes}/${dia}`);
                }
            }

            renderChart(historicoLabels, historicoData, predicaoData);
        }

        function closeIaModal() {
            document.getElementById('modal-ia').style.display = 'none';
        }

        function renderChart(labels, historico, predicao) {
            if(chartInstance) chartInstance.destroy();

            var options = {
                chart: { type: 'line', height: 300, toolbar: {show: false} },
                series: [
                    { name: 'Uso Real (Histórico)', data: historico },
                    { name: 'Predição', data: predicao }
                ],
                colors: ['#2563eb', '#ff9800'], // Azul sólido, Laranja (será pontilhado)
                stroke: { 
                    curve: 'smooth',
                    width: [3, 3],
                    dashArray: [0, 5] // 0 = solido, 5 = pontilhado
                },
                xaxis: { categories: labels },
                dataLabels: { enabled: false },
                markers: { size: 4 }
            };

            chartInstance = new ApexCharts(document.querySelector("#chart-regression"), options);
            chartInstance.render();
        }

        // --- 5. Lógica de Troca de Mapas ---
        document.getElementById('select-mapa').addEventListener('change', function() {
            const divLeaflet = document.getElementById('map');
            const divAnyChart = document.getElementById('container-anychart');

            if(this.value === 'operacionais') {
                // Esconde Leaflet, Mostra AnyChart
                divLeaflet.style.display = 'none';
                divAnyChart.style.display = 'block';
                initAnyChart();
            } else {
                // Esconde AnyChart, Mostra Leaflet
                divAnyChart.style.display = 'none';
                divLeaflet.style.display = 'block';
                // Corrige renderização do Leaflet ao voltar
                setTimeout(() => map.invalidateSize(), 100);
            }
        });

    </script>
</body>

</html>

<script>
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
</script>