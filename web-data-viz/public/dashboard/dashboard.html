<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/imgs/blackscreenicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlackScreen | Dashboards</title>
    
    <link rel="stylesheet" href="./../css/dashboards.css">
    <link rel="stylesheet" href="./../css/style.css" />
    <link rel="stylesheet" href="./../css/dashboardHome.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=account_circle,cancel,check_circle,circle_notifications,close,do_not_disturb_on,docs,health_and_safety,home,keyboard_arrow_up,local_atm,location_on,notifications,search,search_insights" />
    <script src="../js/sessao.js"></script>
    <script src="./../js/alerta.js"></script>

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
        <script src="../js/leaflet-heat.js"></script>

<!-- <body onload=" atualizarFeed()"> -->

    <style>
    </style>
<body>

    <div class="janela">
        <div class="header-left">
            <img src="../assets/imgs/blackscreenlogo.png" alt="BlackScreen">

            <div class="hello">
                <h3>Bem vindo, <br><span id="b_usuario">usuário</span>!</h3>
            </div>

            <div class="links">
                <div class="btn-nav">
                    <a href="dashboard.html">
                        <span class="material-symbols-outlined">
                            home
                        </span>
                        <h3>
                            Ínicio
                        </h3>
                    </a>
                </div>
    
                <div class="btn-nav-white">
                    <a href="./logAlertas.html">
                        <span class="material-symbols-outlined">
                            notifications
                        </span>
                        <h3>
                            Alertas
                        </h3>
                    </a>
                </div>

                <div class="btn-nav-white">
                    <a href="atm.html">
                        <span class="material-symbols-outlined">
                            local_atm
                        </span>
                        <h3>
                            ATMs
                        </h3>
                    </a>
                </div>
    
                <div class="btn-nav-white">
                    <a href="./insight.html">
                        <span class="material-symbols-outlined">
                            search_insights
                        </span>
                        <h3>
                            Insights
                        </h3>
                    </a>
                </div>
    
                <div class="btn-nav-white">
                    <a href="./perfil.html">
                        <span class="material-symbols-outlined">
                            account_circle
                        </span>
                        <h3>
                            Meu Perfil
                        </h3>
                    </a>
                </div>
            </div>

            <div class="btn-logout" onclick="limparSessao()">
                <h3>Sair</h3>
            </div>

        </div>

        <div class="content">
            <div class="top">
                <div class="kpis expanded">
                    <div class="kpi">
                        <h3>Caixas Cadastrados</h3>
                        <h1 id="totalCaixas">178</h1>
                        <div class="status">
                            <div class="status-item">
                                <div class="circle green"></div>
                                <p>Ativos: <span id="caixasAtivos">150</span></p>
                            </div>
                            <div class="status-item">
                                <div class="circle red"></div>
                                <p>Inativos: <span id="caixasInativos">28</span></p>
                            </div>
                        </div>
                    </div>
                    <div class="kpi">
                        <h3><span>Top 3</span> ATMs Mais Alerta</h3>
                        <div class="rank">
                            <div class="header">
                                <p>N*</p><p class="atm">ATM</p><p>Alertas</p>
                            </div>
                            <div class="top3 first" id="top1MaiorAlerta">
                                <p>1*</p><p class="atm">ATM Paulista</p><p class="alertas">14</p>
                            </div>
                            <div class="top3 second" id="top2MaiorAlerta">
                                <p>2*</p><p class="atm">ATM São José</p><p class="alertas">13</p>
                            </div>
                            <div class="top3 third" id="top3MaiorAlerta">
                                <p>3*</p><p class="atm">ATM Iguatemi</p><p class="alertas">8</p>
                            </div>
                        </div>
                    </div>
                    <div class="kpi">
                        <h3><span>Top 3</span> Componentes Mais Alerta</h3>
                        <div class="rank">
                            <div class="header">
                                <p>N*</p><p class="atm">Componente</p><p>Alertas</p>
                            </div>
                            <div class="top3 first" id="top1MaiorAlerta">
                                <p>1*</p><p class="atm">CPU</p><p class="alertas">14</p>
                            </div>
                            <div class="top3 second" id="top2MaiorAlerta">
                                <p>2*</p><p class="atm">Rede</p><p class="alertas">13</p>
                            </div>
                            <div class="top3 third" id="top3MaiorAlerta">
                                <p>3*</p><p class="atm">Disco</p><p class="alertas">8</p>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn-expand-kpi material-symbols-outlined">keyboard_arrow_up</button>
    
                <div class="pesquisa-filtros">
                    <div class="pesquisa-div">
                        <input type="text" id="pesquisa" placeholder="Pesquisar..." onkeyup="">
                        <span class="material-symbols-outlined">search</span>
                    </div>
                    <select name="slt_tipo_mapa" id="">
                        <option value="todos">Todos</option>
                        <option value="operacionais">Mapa de Calor</option>
                    </select>
                </div>
            </div>
            <div id="map"></div>
        </div>

        <div id="modal">
            <div id="modalContainer">
                <div class="header" onclick="closeModal()">
                    <h1 id="caixa-name"></h1>
                    <button class="material-symbols-outlined close">close</button>
                </div>
                <div class="contentModal">
                    <div class="left">
                        <div class="item">
                            <div class="title">
                                <span class="material-symbols-outlined">location_on</span>
                                <h2>Localização</h2>
                            </div>
                            <p id="caixa-endereco">Rua Exemplo, 123 - Bairro, Cidade/UF</p>
                        </div>
                        <div class="item">
                            <div class="title">
                                <span class="material-symbols-outlined">docs</span>
                                <h2>Visão Geral</h2>
                            </div>
                            <h3>Status:</h3>
                            <p id="caixa-status" class="status ativo">
                                <span class="material-symbols-outlined">check_circle</span>
                                Ativo
                            </p>
                            <h3>Componentes:</h3>
                            <div class="components" id="component-container">
                                <p class="status bom">
                                    <span class="material-symbols-outlined">check_circle</span>
                                    Impressora de Recibos
                                </p>
                                <p class="status bom">
                                    <span class="material-symbols-outlined">check_circle</span>
                                    Teclado
                                </p>
                                <p class="status bom">
                                    <span class="material-symbols-outlined">check_circle</span>
                                    Conexão
                                </p>
                                <p class="status alerta">
                                    <span class="material-symbols-outlined">circle_notifications</span>
                                    Dispensador de Cédulas
                                </p>
                                <p class="status falha">
                                    <span class="material-symbols-outlined">do_not_disturb_on</span>
                                    Leitor de Cartão
                                </p>
                            </div>
                            <h3>Alertas Recentes:</h3>
                            <table>
                                <tr>
                                    <th>Data</th>
                                    <th>Componente</th>
                                    <th>Descrição</th>
                                </tr>
                                <tr>
                                    <td>2024-06-15 14:32</td>
                                    <td>CPU</td>
                                    <td>Uso elevado da CPU (74%)</td>
                                </tr>
                                <tr>
                                    <td>2024-06-14 09:21</td>
                                    <td>Disco</td>
                                    <td>Espaço em disco baixo (10% restante)</td>
                                </tr>
                                <tr>
                                    <td>2024-06-13 16:45</td>
                                    <td>Rede</td>
                                    <td>Conexão intermitente detectada</td>
                                </tr>
                                
                                <tr>
                                    <td>2024-06-15 14:32</td>
                                    <td>CPU</td>
                                    <td>Uso elevado da CPU (74%)</td>
                                </tr>
                                <tr>
                                    <td>2024-06-14 09:21</td>
                                    <td>Disco</td>
                                    <td>Espaço em disco baixo (10% restante)</td>
                                </tr>
                                <tr>
                                    <td>2024-06-13 16:45</td>
                                    <td>Rede</td>
                                    <td>Conexão intermitente detectada</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="right">
                        <div class="title">
                            <span class="material-symbols-outlined">health_and_safety</span>
                            <h2>Saúde do Sistema</h2>
                        </div>
                        <div class="stats cpu">
                            <h3>CPU</h3>
                            <div class="progress-bar">
                                <div class="progress" style="width: 98%;"></div>
                            </div>
                            <div class="stat usoAtual">
                                <div class="circle ruim"></div>
                                <p>Uso: <span>98%</span></p>
                            </div>
                            <div class="stat tempAtual">
                                <div class="circle bom"></div>
                                <p>Temperatura: <span>55°C</span></p>
                            </div>
                            <div class="stat totalProcessos">
                                <div class="circle bom"></div>
                                <p>Total de Processos: <span>123</span></p>
                            </div>
                        </div>
                        <div class="stats ram">
                            <h3>RAM</h3>
                            <div class="progress-bar">
                                <div class="progress" style="width: 58%;"></div>
                            </div>
                            <div class="stat usoAtual">
                                <div class="circle bom"></div>
                                <p>Uso: <span>58%</span></p>
                            </div>
                        </div>
                        <div class="stats disco">
                            <h3>Disco</h3>
                            <div class="progress-bar">
                                <div class="progress" style="width: 62%;"></div>
                            </div>
                            <div class="stat usoAtual">
                                <div class="circle bom"></div>
                                <p>Uso: <span>62%</span></p>
                            </div>
                        </div>
                        <div class="stats rede">
                            <h3>Rede</h3>
                            <div class="stat ping">
                                <div class="circle bom"></div>
                                <p>Uso: <span>42 ms</span></p>
                            </div>
                            <div class="stat percaPacotes">
                                <div class="circle bom"></div>
                                <p>Perca de Pacotes: <span>0 %</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="">
        </script>


    <script>
        document.querySelector('.btn-expand-kpi').addEventListener('click', function(){
            const kpis = document.querySelector('.content .kpis');
            kpis.classList.toggle('expanded');
            if (kpis.classList.contains('expanded')) {
                this.style.rotate = '0deg';
            } else {
                this.style.rotate = '180deg';
            }
        });

        function closeModal(){
            document.getElementById('modal').style.display = "none";
        }

        const icon = L.icon({
            iconUrl: '../assets/imgs/marker.png',
            shadowUrl: '../assets/imgs/marker_shadow.png',

            iconSize:     [48, 95],
            shadowSize:   [50, 64],
            iconAnchor:   [22, 94],
            shadowAnchor: [0, 72],
            popupAnchor:  [-3, -76]
        });

        const map = L.map('map').setView([-23.55052, -46.633308], 12);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19, attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        // const heat = L.heatLayer([
        //     [-23.55052, -46.633308, 0.5]
        // ], {radius: 25}).addTo(map);

        fetch('/caixas')
            .then(r => r.json())
            .then(lista => {
                const group = L.featureGroup();
                lista.forEach(c => {
                    if (c.latitude == null || c.longitude == null) return;

                    marker = L.marker([c.latitude, c.longitude], {icon: icon})
                        .bindPopup(
                            `<b>${c.codigoCaixa}</b><br>${c.logradouro}, ${c.numero}<br>${c.bairro} - ${c.cidade}/${c.uf}<br> <i>Empresa dona: </i>${c.eNome}<br> <i>Código da empresa: </i> ${c.idEmpresa}`
                        )
                        .addTo(group);
                    marker.on('mouseover',function(ev) {
                        ev.target.openPopup();
                    });
                    marker.on('mouseout',function(ev) {
                        ev.target.closePopup();
                    });
                    
                    marker.on('click', function (e){
                        document.getElementById('modal').style.display = "flex";
                        document.getElementById('caixa-name').textContent = c.codigoCaixa;
                        document.getElementById('caixa-endereco').textContent = `${c.logradouro}, ${c.numero} - ${c.bairro}, ${c.cidade}/${c.uf}`;
                        statusCaixa = 1;
                        if(statusCaixa === 1){
                            document.getElementById('caixa-status').classList.remove('inativo');
                            document.getElementById('caixa-status').classList.add('ativo');
                            document.getElementById('caixa-status').innerHTML = `
                                <span class="material-symbols-outlined">check_circle</span>
                                Ativo
                            `;
                        } else {
                            document.getElementById('caixa-status').classList.remove('ativo');
                            document.getElementById('caixa-status').classList.add('inativo');
                            document.getElementById('caixa-status').innerHTML = `
                                <span class="material-symbols-outlined">cancel</span>
                                Inativo
                            `;
                        }
                    });
                });

                if (group.getLayers().length) {
                    group.addTo(map);
                    try { map.fitBounds(group.getBounds().pad(0.2)); } catch (_) { }
                }
            })
            .catch(err => console.error("Falha ao carregar /caixas:", err));
    </script>
</body>

</html>

<script>
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

</script>
