<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/imgs/blackscreenicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlackScreen | Dashboards</title>
    
    <!-- CSS Originais -->
    <link rel="stylesheet" href="./../css/dashboards.css">
    <link rel="stylesheet" href="./../css/style.css" />
    <link rel="stylesheet" href="./../css/dashboardHome.css">
    <link rel="stylesheet" href="./../css/dashboardCalor.css">
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    
    <script src="../js/sessao.js"></script>
    <script src="./../js/alerta.js"></script>

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">


    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-bundle.min.js"></script>
    <script src="https://cdn.anychart.com/releases/8.11.0/geodata/custom/world/world.js"></script>
    <script src="https://cdn.anychart.com/releases/8.11.0/geodata/countries/brazil/brazil.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.15/proj4.js"></script>
    <link rel="stylesheet" href="https://cdn.anychart.com/releases/8.11.0/css/anychart-ui.min.css">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

</head>
<body>    
    <div class="janela">
        <div class="header-left">
            <img src="../assets/imgs/blackscreenlogo.png" alt="BlackScreen">

            <div class="hello">
                <h3>Bem vindo, <br><span id="b_usuario">usuário</span>!</h3>
            </div>

           <div class="links">
                <div class="btn-nav">
                    <a href="../dashboard/dashboard.html">
                        <span class="material-symbols-outlined">
                            home
                        </span>
                        <h3>
                            Ínicio
                        </h3>
                    </a>
                </div>

                <div class="btn-nav-white">
                    <a href="../dashboard/atm.html">
                        <span class="material-symbols-outlined">
                            local_atm
                        </span>
                        <h3>
                            ATMs
                        </h3>
                    </a>
                </div>

                <div class="btn-nav-white">
                    <a href="../dashboard/cadastroComponentes.html">
                        <span class="material-symbols-outlined">
                            health_and_safety
                        </span>
                        <h3>
                            Componentes
                        </h3>
                    </a>
                </div>

                <!-- <div class="btn-nav-white">
                    <a href="../dashLukas/persona.html">
                        <span class="material-symbols-outlined">
                            signal_cellular_alt
                        </span>
                        <h3>
                            Persona
                        </h3>
                    </a>
                </div> -->



                <div class="btn-nav-white">
                    <a href="../dashboardIndiceDisponibilidade/indiceDisponibilidade.html">
                        <span class="material-symbols-outlined">
                            search_insights
                        </span>
                        <h3>
                            Visão de Processos
                        </h3>
                    </a>
                </div>
                <div class="btn-nav-white">
                    <a href="../dashboard/relatorio_ia.html">
                        <span class="material-symbols-outlined">
                            assignment
                        </span>
                        <h3>
                            Relatórios IA
                        </h3>
                    </a>
                </div>
                <div class="btn-nav-white">
                    <a href="./perfil.html">
                        <span class="material-symbols-outlined">
                            account_circle
                        </span>
                        <h3>
                            Meu Perfil
                        </h3>
                    </a>
                </div>
            </div>

            <div class="btn-logout" onclick="limparSessao()">
                <h3>Sair</h3>
            </div>

        </div>

        <div class="content">
            <div class="top">
                <div class="kpis expanded">
                    <div class="kpi">
                        <h3>Caixas Cadastrados</h3>
                        <h1 id="totalCaixas">0</h1>
                        <div class="status">
                            <div class="status-item">
                                <div class="circle green"></div>
                                <p>Ativos: <span id="caixasAtivos">150</span></p>
                            </div>
                            <div class="status-item">
                                <div class="circle red"></div>
                                <p>Inativos: <span id="caixasInativos">28</span></p>
                            </div>
                        </div>
                    </div>
                    <div class="kpi">
                        <h3><span>Top 3</span> ATMs por Consumo Mediano de RAM</h3>
                        <div class="rank">
                            <div class="header">
                                <p>N*</p><p class="atm">ATM</p><p>RAM (mediana)</p>
                            </div>
                            <div class="top3 first" id="topRam1">
                                <p>1*</p><p class="atm">-</p><p class="alertas">-</p>
                            </div>
                            <div class="top3 second" id="topRam2">
                                <p>2*</p><p class="atm">-</p><p class="alertas">-</p>
                            </div>
                            <div class="top3 third" id="topRam3">
                                <p>3*</p><p class="atm">-</p><p class="alertas">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="kpi">
                        <h3><span>Top 3</span> ATMs por Maior Uso de Rede</h3>
                        <div class="rank">
                            <div class="header">
                                <p>N*</p><p class="atm">ATM</p><p>Rede (MB/s)</p>
                            </div>
                            <div class="top3 first" id="topLat1">
                                <p>1*</p><p class="atm">-</p><p class="alertas">-</p>
                            </div>
                            <div class="top3 second" id="topLat2">
                                <p>2*</p><p class="atm">-</p><p class="alertas">-</p>
                            </div>
                            <div class="top3 third" id="topLat3">
                                <p>3*</p><p class="atm">-</p><p class="alertas">-</p>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn-expand-kpi material-symbols-outlined">keyboard_arrow_up</button>
    
                <div class="pesquisa-filtros">
                    <div class="pesquisa-div" style="position: relative; z-index: 9999;">
                        <input type="text" id="pesquisa" placeholder="Pesquisar..." onkeyup="filtrarCaixas()">
                        <span class="material-symbols-outlined">search</span>
                        <div id="search-results" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #ccc; z-index: 99999; max-height: 200px; overflow-y: auto; border-radius: 0 0 5px 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: #333;"></div>
                    </div>
                    <select name="slt_tipo_mapa" id="select-mapa">
                        <option value="padrao">Localização</option>
                        <option value="operacionais">Mapa de Calor</option>
                    </select>
                </div>
            </div>
            <div id="map-container-wrapper">
                <div id="map"></div>
                <div id="container-anychart">
                    <button id="btn-voltar-mundo" onclick="renderWorldMap()">
                        <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 18px;">arrow_back</span> 
                        Voltar ao Mundo
                    </button>
                </div>
            </div>
        </div>
        <div id="modal">
            <div id="modalContainer">
                <div class="header" onclick="closeModal()">
                    <h1 id="caixa-name"></h1>
                    <button class="material-symbols-outlined close">close</button>
                </div>
                <div class="contentModal">
                    <div class="left">
                        <div class="item">
                            <div class="title">
                                <span class="material-symbols-outlined">location_on</span>
                                <h2>Localização</h2>
                            </div>
                            <p id="caixa-endereco">Rua Exemplo, 123 - Bairro, Cidade/UF</p>
                        </div>
                        <div class="item">
                            <div class="title">
                                <span class="material-symbols-outlined">docs</span>
                                <h2>Visão Geral</h2>
                            </div>
                            <h3>Status:</h3>
                            <p id="caixa-status" class="status ativo">
                                <span class="material-symbols-outlined">check_circle</span>
                                Ativo
                            </p>
                            <h3>Componentes:</h3>
                            <div class="components" id="component-container">
                                <p class="status bom">
                                    <span class="material-symbols-outlined">check_circle</span>
                                    Impressora de Recibos
                                </p>
                                <p class="status bom">
                                    <span class="material-symbols-outlined">check_circle</span>
                                    Teclado
                                </p>
                                <p class="status bom">
                                    <span class="material-symbols-outlined">check_circle</span>
                                    Conexão
                                </p>
                                <p class="status alerta">
                                    <span class="material-symbols-outlined">circle_notifications</span>
                                    Dispensador de Cédulas
                                </p>
                                <p class="status falha">
                                    <span class="material-symbols-outlined">do_not_disturb_on</span>
                                    Leitor de Cartão
                                </p>
                            </div>
                            <h3>Alertas Recentes:</h3>
                            <table>
                                <tr>
                                    <th>Data</th>
                                    <th>Componente</th>
                                    <th>Descrição</th>
                                </tr>
                                <tr>
                                    <td>2024-06-15 14:32</td>
                                    <td>CPU</td>
                                    <td>Uso elevado da CPU (74%)</td>
                                </tr>
                                <!-- Linhas originais mantidas -->
                            </table>
                        </div>
                    </div>
                    <div class="right">
                        <div class="title">
                            <span class="material-symbols-outlined">health_and_safety</span>
                            <h2>Saúde do Sistema</h2>
                        </div>
                        <div class="stats cpu">
                            <h3>CPU</h3>
                            <div class="progress-bar">
                                <div class="progress" style="width: 98%;"></div>
                            </div>
                            <div class="stat usoAtual">
                                <div class="circle ruim"></div>
                                <p>Uso: <span>98%</span></p>
                            </div>
                            <div class="stat tempAtual">
                                <div class="circle bom"></div>
                                <p>Temperatura: <span>55°C</span></p>
                            </div>
                            <div class="stat totalProcessos">
                                <div class="circle bom"></div>
                                <p>Total de Processos: <span>123</span></p>
                            </div>
                        </div>
                        <!-- Outras stats mantidas... -->
                    </div>
                </div>
            </div>
        </div>

        <div id="modal-ia">
            <div class="modal-ia-content">
                <div class="modal-ia-header">
                    <div>
                        <h2 id="modal-ia-title">Tendência e Previsão (24h)</h2>
                        <p>Análise baseada nos últimos 7 dias</p>
                    </div>
                    <div style="margin-left: auto; margin-right: 20px;">
                        <select id="select-metric" style="padding: 8px; border-radius: 5px; border: 1px solid #ccc;" onchange="updateIaChart()">
                            <option value="cpu">CPU</option>
                            <option value="ram">RAM</option>
                            <option value="rede">Rede</option>
                        </select>
                    </div>
                    <button class="btn-close-ia material-symbols-outlined" onclick="closeIaModal()">close</button>
                </div>
                <div class="modal-ia-body">
                    <div class="kpi-grid">
                        <div class="kpi-card blue">
                            <div class="kpi-label">Mediana CPU</div>
                            <div class="kpi-value" id="ia-cpu">45%</div>
                        </div>
                        <div class="kpi-card purple">
                            <div class="kpi-label">Mediana RAM</div>
                            <div class="kpi-value" id="ia-ram">8.2 GB</div>
                        </div>
                        <div class="kpi-card orange">
                            <div class="kpi-label">Mediana Disco</div>
                            <div class="kpi-value" id="ia-disk">72%</div>
                        </div>
                        <div class="kpi-card green">
                            <div class="kpi-label">Rede (I/O)</div>
                            <div class="kpi-value" id="ia-net">450 MB/s</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 style="margin-bottom: 10px; color: #333;">Previsão de Consumo (Próximas 24h)</h3>
                        <div id="chart-regression" style="width: 100%; height: 300px;"></div>
                    </div>


                </div>
            </div>
        </div>
        
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="">
    </script>
    <script src="../js/leaflet-heat.js"></script>


    <script>
        document.querySelector('.btn-expand-kpi').addEventListener('click', function(){
            const kpis = document.querySelector('.content .kpis');
            kpis.classList.toggle('expanded');
            if (kpis.classList.contains('expanded')) {
                this.style.rotate = '0deg';
            } else {
                this.style.rotate = '180deg';
            }
        });

        function closeModal(){
            document.getElementById('modal').style.display = "none";
        }

        // --- 2. Leaflet Map (Código Original Mantido) ---
        const icon = L.icon({
            iconUrl: '../assets/imgs/marker.png',
            shadowUrl: '../assets/imgs/marker_shadow.png',
            iconSize:     [48, 95],
            shadowSize:   [50, 64],
            iconAnchor:   [22, 94],
            shadowAnchor: [0, 72],
            popupAnchor:  [-3, -76]
        });

        // ZOOM CONTROL DISABLED HERE
        const map = L.map('map', { zoomControl: false }).setView([-23.55052, -46.633308], 12);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19, attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        const fkEmpresa = sessionStorage.getItem("FK_EMPRESA");
        
        let listaGlobalCaixas = [];
        let markersMap = {};

        fetch('/caixas/listar', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'FK_EMPRESA': fkEmpresa
            },
        })
            .then(r => r.json())
            .then(lista => {
                listaGlobalCaixas = lista;
                const group = L.featureGroup();
                lista.forEach(c => {
                    if (c.Latitude == null || c.Longitude == null) return;

                    marker = L.marker([c.Latitude, c.Longitude], {icon: icon})
                        .bindPopup(
                            `<b>${c.codigoCaixa}</b><br>${c.Logradouro}<br>${c.Bairro} - ${c.Cidade}/${c.UF}<br> <i>Empresa dona: </i>${c.eNome}<br> <i>Código da empresa: </i> ${c.Id_Empresa}`
                        )
                        .addTo(group);
                    
                    markersMap[c.codigoCaixa] = marker;

                    marker.on('mouseover',function(ev) {
                        ev.target.openPopup();
                    });
                    marker.on('mouseout',function(ev) {
                        ev.target.closePopup();
                    });
                    
                    marker.on('click', function (e){
                        document.getElementById('modal').style.display = "flex";
                        document.getElementById('caixa-name').textContent = c.codigoCaixa;
                        document.getElementById('caixa-endereco').textContent = `${c.Logradouro} - ${c.Bairro}, ${c.Cidade}/${c.UF}`;
                        statusCaixa = 1;
                        if(statusCaixa === 1){
                            document.getElementById('caixa-status').classList.remove('inativo');
                            document.getElementById('caixa-status').classList.add('ativo');
                            document.getElementById('caixa-status').innerHTML = `
                                <span class="material-symbols-outlined">check_circle</span>
                                Ativo
                            `;
                        } else {
                            document.getElementById('caixa-status').classList.remove('ativo');
                            document.getElementById('caixa-status').classList.add('inativo');
                            document.getElementById('caixa-status').innerHTML = `
                                <span class="material-symbols-outlined">cancel</span>
                                Inativo
                            `;
                        }
                    });
                });

                if (group.getLayers().length) {
                    group.addTo(map);
                    try { map.fitBounds(group.getBounds().pad(0.2)); } catch (_) { }
                }
                    // Atualizar contadores do dashboard com a lista retornada
                    try {
                        const total = lista.length;
                        let ativos = lista.filter(c => c.Ativo == 1 || c.ativo == 1 || c.status == 'Ativo' || c.status == 'ativo' || c.Status == 'ativo' || c.Status == 'Ativo').length;
                        // Se não houver informação de status no resultado, assume que todas as caixas retornadas estão ativas
                        if (ativos === 0) ativos = total;
                        const inativos = Math.max(0, total - ativos);

                        const elTotal = document.getElementById('totalCaixas');
                        const elAtivos = document.getElementById('caixasAtivos');
                        const elInativos = document.getElementById('caixasInativos');

                        if (elTotal) elTotal.textContent = total;
                        if (elAtivos) elAtivos.textContent = ativos;
                        if (elInativos) elInativos.textContent = inativos;
                    } catch (e) {
                        console.error('Erro ao atualizar contadores de caixas:', e);
                    }
                    
                    // Carregar dados do bucket para os KPIs Top 3
                    fetchAndProcessBucketData();
            })
            .catch(err => console.error("Falha ao carregar /caixas:", err));
        


        // --- 3. Novas Funcionalidades (AnyChart + ApexCharts) ---
        let mapAnyChart;
        let chartInstance = null;
        let anyChartInitialized = false;
        let dadosBucketCache = []; // Cache para evitar requisições repetidas

        // Função para buscar dados do bucket e processar para o mapa
        async function fetchAndProcessBucketData() {
            try {
                const response = await fetch('/bucket/dashboard');
                const dados = await response.json();
                dadosBucketCache = dados;
                
                // Atualiza os KPIs de Top 3
                try { computeTop3RamAndLatency(); } catch(e) { console.error(e); }
                
                // Processar dados para o formato do AnyChart
                // Agrupar por UF
                const dadosPorEstado = {};
                
                dados.forEach(d => {
                    // O backend já retorna 'uf' cruzado com o banco
                    const uf = d.uf || 'SP'; 
                    const idMap = `BR.${uf.toUpperCase()}`;
                    
                    if (!dadosPorEstado[idMap]) {
                        dadosPorEstado[idMap] = { 
                            id: idMap, 
                            value: 0, 
                            name: uf, 
                            maquinas: [],
                            total: 0 
                        };
                    }
                    
                    dadosPorEstado[idMap].value += 1; // Contagem de máquinas
                    dadosPorEstado[idMap].maquinas.push(d.dados);
                });

                // Converter para array
                return Object.values(dadosPorEstado).map(estado => {
                    // Calcular média de CPU para o estado
                    let totalCpu = 0;
                    let count = 0;
                    
                    estado.maquinas.forEach(json => {
                        // Estrutura: json.kpis.daily_median.cpu
                        const cpu = parseFloat(json.kpis?.daily_median?.cpu || 0);
                        totalCpu += cpu;
                        count++;
                    });

                    const avgCpu = count > 0 ? (totalCpu / count).toFixed(1) : 0;

                    return {
                        id: estado.id,
                        value: estado.value, // Quantidade de registros
                        name: estado.name,
                        avg_cpu: avgCpu,
                        total: estado.value // Total de registros
                    };
                });

            } catch (error) {
                console.error("Erro ao buscar dados para o mapa:", error);
                return [];
            }
        }

        const worldData = [
            { id: "BR", value: 0, name: "Brasil" }
        ];

        // Dados iniciais vazios, serão preenchidos pelo fetch
        let brazilData = [];

        async function initAnyChart() {
            if(anyChartInitialized) return;
            
            // Carregar dados antes de renderizar
            const dadosProcessados = await fetchAndProcessBucketData();
            if (dadosProcessados.length > 0) {
                brazilData = dadosProcessados;

                // Atualizar total do Brasil somando as máquinas de todos os estados
                const totalBrasil = dadosProcessados.reduce((acc, curr) => acc + curr.value, 0);
                const brData = worldData.find(w => w.id === "BR");
                if (brData) brData.value = totalBrasil;
            } else {
                // Fallback se não tiver dados
                brazilData = [
                    { id: "BR.SP", value: 0, name: "São Paulo", avg_cpu: 0, total: 0 }
                ];
            }

            renderWorldMap();
            anyChartInitialized = true;
        }

        function renderWorldMap() {
            document.getElementById('container-anychart').innerHTML = ''; 
            const btn = document.createElement('button');
            btn.id = 'btn-voltar-mundo';
            btn.onclick = renderWorldMap;
            btn.innerHTML = '<span class="material-symbols-outlined" style="vertical-align: middle; font-size: 18px;">arrow_back</span> Voltar ao Mundo';
            document.getElementById('container-anychart').appendChild(btn);
            btn.style.display = 'none'; 

            mapAnyChart = anychart.map();
            mapAnyChart.geoData(anychart.maps.world);
            
            mapAnyChart.background().fill('#808080');

            var colorScale = anychart.scales.linearColor();
            colorScale.colors(['#dbeafe', '#3b82f6', '#1e40af', '#051e3e']);

            var series = mapAnyChart.choropleth(worldData);
            series.colorScale(colorScale);
            series.hovered().fill('#facc15');
            series.labels(false);
            series.tooltip().format("Máquinas: {%value}");

            mapAnyChart.listen("pointClick", function(e) {
                if(e.point.get("id") === "BR") renderBrazilMap();
            });

            if(mapAnyChart.zoomControl) {
                mapAnyChart.zoomControl().render(mapAnyChart);
            }

            mapAnyChart.container("container-anychart");
            mapAnyChart.draw();
        }

        function renderBrazilMap() {
            document.getElementById('container-anychart').innerHTML = '';
            
            const btn = document.createElement('button');
            btn.id = 'btn-voltar-mundo';
            btn.onclick = renderWorldMap;
            btn.innerHTML = '<span class="material-symbols-outlined" style="vertical-align: middle; font-size: 18px;">arrow_back</span> Voltar ao Mundo';
            btn.style.display = 'block';
            document.getElementById('container-anychart').appendChild(btn);

            mapAnyChart = anychart.map();
            mapAnyChart.geoData(anychart.maps.brazil);

            mapAnyChart.background().fill('#808080');

            var colorScale = anychart.scales.linearColor();
            colorScale.colors(['#bfdbfe', '#2563eb', '#051e3e']);

            var series = mapAnyChart.choropleth(brazilData);
            series.colorScale(colorScale);
            series.hovered().fill('#facc15');
            series.labels(false);
            
            series.tooltip().useHtml(true);
            series.tooltip().format(function() {
                return `Máquinas: <b>${this.value}</b>`;
            });

            mapAnyChart.listen("pointClick", function(e) {
                openIaModal(e.point.get("name"));
            });
            
             if(mapAnyChart.zoomControl) {
                mapAnyChart.zoomControl().render(mapAnyChart);
            }

            mapAnyChart.container("container-anychart");
            mapAnyChart.draw();
        }

        // --- 4. Lógica do Novo Modal IA ---
        let currentEstadoData = [];

        async function openIaModal(estadoNome) {
            const modal = document.getElementById('modal-ia');
            document.getElementById('modal-ia-title').innerText = `Tendência e Previsão (24h) - ${estadoNome}`;
            
            // Loading state
            document.getElementById('ia-cpu').innerText = "...";
            document.getElementById('ia-ram').innerText = "...";

            modal.style.display = 'flex';
            
            // Usar dados do cache se disponíveis, senão buscar
            let dados = dadosBucketCache;
            if (!dados || dados.length === 0) {
                try {
                    const response = await fetch('/bucket/dashboard');
                    dados = await response.json();
                    dadosBucketCache = dados;
                    try { computeTop3RamAndLatency(); } catch(e) { console.error(e); }
                } catch (error) {
                    console.error("Erro ao buscar dados:", error);
                    return;
                }
            }

            // Filtrar dados pelo estado selecionado
            const dadosEstado = dados.filter(d => {
                const uf = d.uf || '';
                const mapUf = {
                    "Acre": "AC", "Alagoas": "AL", "Amapá": "AP", "Amazonas": "AM", "Bahia": "BA", "Ceará": "CE", "Distrito Federal": "DF", "Espírito Santo": "ES", "Goiás": "GO", "Maranhão": "MA", "Mato Grosso": "MT", "Mato Grosso do Sul": "MS", "Minas Gerais": "MG", "Pará": "PA", "Paraíba": "PB", "Paraná": "PR", "Pernambuco": "PE", "Piauí": "PI", "Rio de Janeiro": "RJ", "Rio Grande do Norte": "RN", "Rio Grande do Sul": "RS", "Rondônia": "RO", "Roraima": "RR", "Santa Catarina": "SC", "São Paulo": "SP", "Sergipe": "SE", "Tocantins": "TO"
                };
                
                const ufEsperada = mapUf[estadoNome] || estadoNome;
                return uf === ufEsperada;
            });

            currentEstadoData = dadosEstado;

            if (dadosEstado.length === 0) {
                 renderChart([], []);
                 return;
            }

            // Calcular KPIs reais baseados nos dados filtrados
            let totalCpu = 0;
            let totalRam = 0;
            let totalDisco = 0;
            let totalRede = 0;
            let count = 0;
            
            dadosEstado.forEach(d => {
                const json = d.dados;
                totalCpu += parseFloat(json.kpis?.daily_median?.cpu || 0);
                totalRam += parseFloat(json.kpis?.daily_median?.ram || 0);
                totalDisco += parseFloat(json.kpis?.daily_median?.disco || 0);
                totalRede += parseFloat(json.kpis?.daily_median?.rede || 0);
                count++;
            });
            
            const mediaCpu = count > 0 ? (totalCpu / count).toFixed(1) : 0;
            const mediaRam = count > 0 ? (totalRam / count).toFixed(1) : 0;
            const mediaDisco = count > 0 ? (totalDisco / count).toFixed(1) : 0;
            const mediaRede = count > 0 ? (totalRede / count).toFixed(1) : 0;

            document.getElementById('ia-cpu').innerText = mediaCpu + "%";
            document.getElementById('ia-ram').innerText = mediaRam + "%"; 
            document.getElementById('ia-disk').innerText = mediaDisco + "%";
            document.getElementById('ia-net').innerText = mediaRede + " MB/s"; 
            
            // Resetar select para CPU
            const select = document.getElementById('select-metric');
            if(select) select.value = 'cpu';

            updateIaChart();
        }

        function updateIaChart() {
            const metric = document.getElementById('select-metric').value; // 'cpu' or 'ram'
            const dadosEstado = currentEstadoData;

            if (!dadosEstado || dadosEstado.length === 0) return;

            // Preparar dados para o gráfico (Histórico vs Predição)
            // Agrupar dados por timestamp
            const aggReal = {};
            const aggPred = {};

            dadosEstado.forEach(d => {
                const json = d.dados;
                // Acessa chartData.cpu ou chartData.ram dinamicamente
                const metricData = json.chartData?.[metric];
                
                if (metricData) {
                    if (metricData.real) {
                        metricData.real.forEach(point => {
                            if (!aggReal[point.x]) aggReal[point.x] = { sum: 0, count: 0 };
                            aggReal[point.x].sum += point.y;
                            aggReal[point.x].count++;
                        });
                    }
                    if (metricData.prediction) {
                        metricData.prediction.forEach(point => {
                            if (!aggPred[point.x]) aggPred[point.x] = { sum: 0, count: 0 };
                            aggPred[point.x].sum += point.y;
                            aggPred[point.x].count++;
                        });
                    }
                }
            });

            // Converter para arrays e ordenar
            const sortedKeysReal = Object.keys(aggReal).sort();
            const sortedKeysPred = Object.keys(aggPred).sort();

            const seriesReal = sortedKeysReal.map(k => ({
                x: k, 
                y: parseFloat((aggReal[k].sum / aggReal[k].count).toFixed(2))
            }));

            const seriesPred = sortedKeysPred.map(k => ({
                x: k,
                y: parseFloat((aggPred[k].sum / aggPred[k].count).toFixed(2))
            }));

            // Conectar as linhas: Adiciona o último ponto real ao início da predição para evitar buracos
            let lastRealPoint = null;
            if (seriesReal.length > 0) {
                lastRealPoint = seriesReal[seriesReal.length - 1];
                if (seriesPred.length > 0) {
                    seriesPred.unshift(lastRealPoint);
                }
            }

            renderChart(seriesReal, seriesPred, lastRealPoint ? lastRealPoint.x : null);
        }

        function closeIaModal() {
            document.getElementById('modal-ia').style.display = 'none';
        }

        function renderChart(realData, predData, nowTimestamp) {
            if(chartInstance) chartInstance.destroy();

            var options = {
                chart: { 
                    type: 'line', 
                    height: 300, 
                    toolbar: {show: false},
                    animations: { enabled: false }
                },
                series: [
                    { name: 'Histórico', type: 'area', data: realData },
                    { name: 'Previsão', type: 'line', data: predData }
                ],
                colors: ['#2563eb', '#ff9800'], 
                fill: {
                    type: ['gradient', 'solid'],
                    gradient: {
                        shadeIntensity: 1,
                        opacityFrom: 0.7,
                        opacityTo: 0.3,
                        stops: [0, 90, 100]
                    }
                },
                stroke: { 
                    curve: 'smooth',
                    width: [2, 2],
                    dashArray: [0, 5] 
                },
                xaxis: { 
                    type: 'datetime',
                    labels: { 
                        datetimeFormatter: { 
                            year: 'yyyy', 
                            month: 'dd MMM', 
                            day: 'dd MMM', 
                            hour: 'HH:mm' 
                        } 
                    },
                    tooltip: { enabled: false }
                },
                annotations: {
                    xaxis: nowTimestamp ? [{
                        x: nowTimestamp,
                        borderColor: '#999',
                        label: {
                            style: {
                                color: '#fff',
                                background: '#775DD0',
                            },
                            text: 'Agora',
                            orientation: 'vertical'
                        }
                    }] : []
                },
                dataLabels: { enabled: false },
                markers: { size: 0 },
                tooltip: {
                    x: { format: 'dd MMM HH:mm' }
                }
            };

            chartInstance = new ApexCharts(document.querySelector("#chart-regression"), options);
            chartInstance.render();
        }

        // --- 5. Lógica de Troca de Mapas ---
        document.getElementById('select-mapa').addEventListener('change', function() {
            const divLeaflet = document.getElementById('map');
            const divAnyChart = document.getElementById('container-anychart');

            if(this.value === 'operacionais') {
                // Esconde Leaflet, Mostra AnyChart
                divLeaflet.style.display = 'none';
                divAnyChart.style.display = 'block';
                initAnyChart();
            } else {
                // Esconde AnyChart, Mostra Leaflet
                divAnyChart.style.display = 'none';
                divLeaflet.style.display = 'block';
                // Corrige renderização do Leaflet ao voltar
                setTimeout(() => map.invalidateSize(), 100);
            }
        });

        // --- Funções de Pesquisa ---
        
        function computeTop3RamAndLatency() {
            if (!dadosBucketCache || dadosBucketCache.length === 0) return;

            const agrupado = {};
            dadosBucketCache.forEach(entry => {
                // Tenta pegar o código do caixa de várias formas
                const codigo = entry.codigo || entry.codigoCaixa || entry.id || entry.dados?.codigoCaixa || entry.dados?.codigo || entry.macaddress || 'Desconhecido';
                
                if (!agrupado[codigo]) {
                    agrupado[codigo] = [];
                }
                agrupado[codigo].push(entry.dados || {});
            });

            const resumo = Object.keys(agrupado).map(codigo => {
                const arr = agrupado[codigo];
                
                // Extrair valores de RAM e Latência
                const ramVals = arr.map(d => {
                    // Tenta pegar RAM (pode ser 'ram', 'memory', 'mem')
                    return parseFloat(d.kpis?.daily_median?.ram ?? d.kpis?.daily_median?.memory ?? d.kpis?.daily_median?.mem ?? 0);
                }).filter(v => !isNaN(v) && v > 0);

                const latVals = arr.map(d => {
                    // Usando 'rede' como métrica de rede disponível (MB/s)
                    return parseFloat(d.kpis?.daily_median?.rede ?? 0);
                }).filter(v => !isNaN(v) && v > 0);

                // Calcular médias (ou medianas) para este ATM
                const ram = ramVals.length ? (ramVals.reduce((a,b)=>a+b,0)/ramVals.length) : 0;
                const latency = latVals.length ? (latVals.reduce((a,b)=>a+b,0)/latVals.length) : 0;

                return { codigo, ram, latency };
            });

            // Ordenar e pegar Top 3
            const topRam = resumo.filter(r => r.ram > 0).sort((a,b) => b.ram - a.ram).slice(0,3);
            const topLat = resumo.filter(r => r.latency > 0).sort((a,b) => b.latency - a.latency).slice(0,3);

            // Função auxiliar para preencher o HTML
            function setTop(id, rank, item, type) {
                const el = document.getElementById(id);
                if (!el) return;
                
                if (!item) {
                    el.innerHTML = `<p>${rank}*</p><p class="atm">-</p><p class="alertas">-</p>`;
                    return;
                }

                let displayVal = '-';
                if (type === 'ram') {
                    displayVal = `${item.ram.toFixed(1)}%`;
                } else {
                    displayVal = `${item.latency.toFixed(1)} MB/s`;
                }

                el.innerHTML = `<p>${rank}*</p><p class="atm">${item.codigo}</p><p class="alertas">${displayVal}</p>`;
            }

            setTop('topRam1', 1, topRam[0], 'ram');
            setTop('topRam2', 2, topRam[1], 'ram');
            setTop('topRam3', 3, topRam[2], 'ram');

            setTop('topLat1', 1, topLat[0], 'lat');
            setTop('topLat2', 2, topLat[1], 'lat');
            setTop('topLat3', 3, topLat[2], 'lat');
        }

        function filtrarCaixas() {
            const input = document.getElementById('pesquisa');
            const filter = input.value.toUpperCase();
            const resultsContainer = document.getElementById('search-results');
            
            resultsContainer.innerHTML = '';
            
            if (!filter) {
                resultsContainer.style.display = 'none';
                return;
            }

            const filtered = listaGlobalCaixas.filter(c => 
                c.codigoCaixa && c.codigoCaixa.toUpperCase().startsWith(filter)
            );

            if (filtered.length > 0) {
                resultsContainer.style.display = 'block';
                filtered.forEach(c => {
                    const div = document.createElement('div');
                    div.style.padding = '10px';
                    div.style.cursor = 'pointer';
                    div.style.borderBottom = '1px solid #eee';
                    div.style.color = '#333';
                    div.style.fontSize = '14px';
                    div.onmouseover = () => div.style.backgroundColor = '#f0f0f0';
                    div.onmouseout = () => div.style.backgroundColor = '#fff';
                    
                    div.innerText = c.codigoCaixa;
                    div.onclick = () => zoomNoCaixa(c.codigoCaixa, c.Latitude, c.Longitude);
                    resultsContainer.appendChild(div);
                });
            } else {
                resultsContainer.style.display = 'none';
            }
        }

        function zoomNoCaixa(codigo, lat, lng) {
            document.getElementById('search-results').style.display = 'none';
            document.getElementById('pesquisa').value = codigo;
            
            // Garante que o mapa padrão está visível
            const selectMapa = document.getElementById('select-mapa');
            if (selectMapa.value !== 'padrao') {
                selectMapa.value = 'padrao';
                selectMapa.dispatchEvent(new Event('change'));
            }

            if (lat && lng) {
                map.setView([lat, lng], 18);
                const marker = markersMap[codigo];
                if (marker) {
                    marker.openPopup();
                }
            }
        }

    </script>
</body>

</html>

<script>
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
</script>