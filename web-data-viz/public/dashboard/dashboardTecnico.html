<!doctype html>
<html lang="pt-br">
    <head>
        <link
            rel="shortcut icon"
            href="../assets/imgs/blackscreenicon.ico"
            type="image/x-icon"
        />
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>BlackScreen | Mapa Principal</title>

        <link rel="stylesheet" href="./../css/dashboards.css" />
        <link rel="stylesheet" href="./../css/style.css" />
        <link rel="stylesheet" href="./../css/dashboardHome.css" />
        <link rel="stylesheet" href="./../css/cssTecnico.css" />

        <link rel="preconnect" href="https://fonts.gstatic.com" />
        <link
            href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
        />

        <script src="../js/sessao.js"></script>
        <script src="./../js/alerta.js"></script>

        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""
        />
    </head>
    <body>
        <div class="janela">
            <div class="header-left">
                <img
                    src="../assets/imgs/blackscreenlogo.png"
                    alt="BlackScreen"
                />

                <div class="hello">
                    <h3>
                        Bem vindo, <br /><span id="b_usuario">usuário</span>!
                    </h3>
                </div>

                <div class="links">
                    <div class="btn-nav">
                        <a href="../dashboard/dashboard.html">
                            <span class="material-symbols-outlined">home</span>
                            <h3>Ínicio</h3>
                        </a>
                    </div>
                    <div class="btn-nav-white">
                        <a href="../dashboard/logAlertas.html">
                            <span class="material-symbols-outlined"
                                >notifications</span
                            >
                            <h3>Alertas</h3>
                        </a>
                    </div>
                    <div class="btn-nav-white">
                        <a href="../dashboard/atm.html">
                            <span class="material-symbols-outlined"
                                >local_atm</span
                            >
                            <h3>ATMs</h3>
                        </a>
                    </div>
                    <div class="btn-nav-white">
                        <a href="../dashboard/cadastroComponentes.html">
                            <span class="material-symbols-outlined"
                                >health_and_safety</span
                            >
                            <h3>Componentes</h3>
                        </a>
                    </div>
                    <div class="btn-nav-white">
                        <a href="../dashLukas/persona.html">
                            <span class="material-symbols-outlined"
                                >signal_cellular_alt</span
                            >
                            <h3>Persona</h3>
                        </a>
                    </div>
                    <div class="btn-nav-white">
                        <a href="./insight.html">
                            <span class="material-symbols-outlined"
                                >search_insights</span
                            >
                            <h3>Insights</h3>
                        </a>
                    </div>
                    <div class="btn-nav-white">
                        <a href="./perfil.html">
                            <span class="material-symbols-outlined"
                                >account_circle</span
                            >
                            <h3>Meu Perfil</h3>
                        </a>
                    </div>
                    <div class="btn-logout" onclick="limparSessao()">
                        <h3>Sair</h3>
                    </div>
                </div>
            </div>

            <div class="content">
                <div class="top">
                    <div class="pesquisa-filtros">
                        <div class="pesquisa-div">
                            <input
                                type="text"
                                id="pesquisa-caixa"
                                placeholder="Pesquisar caixa..."
                                autocomplete="off"
                            />
                            <span
                                class="material-symbols-outlined"
                                style="
                                    position: absolute;
                                    right: 12px;
                                    top: 50%;
                                    transform: translateY(-50%);
                                    pointer-events: none;
                                    opacity: 0.7;
                                "
                                >search</span
                            >
                            <div
                                id="lista-caixas"
                                class="lista-resultados"
                            ></div>
                        </div>
                    </div>
                </div>

                <div id="map-container-wrapper">
                    <div id="map"></div>
                </div>
            </div>
        </div>

        <script
            src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""
        ></script>

        <script>
            document.getElementById("b_usuario").innerHTML =
                sessionStorage.NOME_USUARIO || "usuário";

            const icon = L.icon({
                iconUrl: "../assets/imgs/marker.png",
                shadowUrl: "../assets/imgs/marker_shadow.png",
                iconSize: [48, 95],
                shadowSize: [50, 64],
                iconAnchor: [22, 94],
                shadowAnchor: [0, 72],
                popupAnchor: [-3, -76],
            });

            const map = L.map("map", { zoomControl: false }).setView(
                [-23.55052, -46.633308],
                12,
            );

            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                maxZoom: 19,
                attribution: "© OpenStreetMap",
            }).addTo(map);

            const fkEmpresa = sessionStorage.getItem("FK_EMPRESA");
            const inputPesquisa = document.getElementById("pesquisa-caixa");
            const listaResultados = document.getElementById("lista-caixas");
            let allCaixas = [];

            // Carrega dados das caixas
            fetch("/caixas/listar", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    FK_EMPRESA: fkEmpresa,
                },
            })
                .then((r) => r.json())
                .then((lista) => {
                    allCaixas = lista.filter(
                        (c) => c.Latitude != null && c.Longitude != null,
                    );

                    const group = L.featureGroup();
                    allCaixas.forEach((c) => {
                        const marker = L.marker([c.Latitude, c.Longitude], {
                            icon: icon,
                        })
                            .bindPopup(
                                `<b>${c.codigoCaixa}</b><br>${c.Logradouro}<br>${c.Bairro} - ${c.Cidade}/${c.UF}<br> <i>Empresa dona: </i>${c.eNome}<br> <i>Código da empresa: </i> ${c.Id_Empresa}`,
                            )
                            .addTo(group);

                        marker.on("mouseover", function (ev) {
                            ev.target.openPopup();
                        });
                        marker.on("mouseout", function (ev) {
                            ev.target.closePopup();
                        });

                        marker.on("click", function () {
                            window.location.href = `../dashboardHercules/caixa.html?id=${c.Macaddress}`;
                        });
                    });

                    if (group.getLayers().length) {
                        group.addTo(map);
                        try {
                            map.fitBounds(group.getBounds().pad(0.2));
                        } catch (_) {}
                    }
                })
                .catch((err) =>
                    console.error("Falha ao carregar /caixas:", err),
                );

            inputPesquisa.addEventListener("input", function () {
                const termo = this.value.toLowerCase().trim();
                listaResultados.innerHTML = "";

                if (termo.length < 2) {
                    listaResultados.style.display = "none";
                    return;
                }

                const resultados = allCaixas.filter(
                    (c) =>
                        c.codigoCaixa.toLowerCase().includes(termo) ||
                        c.Logradouro.toLowerCase().includes(termo) ||
                        c.Bairro.toLowerCase().includes(termo) ||
                        c.Cidade.toLowerCase().includes(termo),
                );

                if (resultados.length > 0) {
                    resultados.slice(0, 8).forEach((c) => {
                        const div = document.createElement("div");
                        div.className = "resultado-caixa";
                        div.innerHTML = `
                        <div>
                            <strong>${c.codigoCaixa}</strong><br>
                            <small>${c.Logradouro}, ${c.Bairro}</small>
                        </div>
                    `;
                        div.onclick = () => {
                            window.location.href = `../dashboardHercules/caixa.html?id=${c.Macaddress}`;
                        };
                        listaResultados.appendChild(div);
                    });
                    listaResultados.style.display = "block";
                } else {
                    listaResultados.style.display = "none";
                }
            });

            document.addEventListener("click", function (e) {
                if (
                    !inputPesquisa.contains(e.target) &&
                    !listaResultados.contains(e.target)
                ) {
                    listaResultados.style.display = "none";
                }
            });
        </script>
    </body>
</html>
