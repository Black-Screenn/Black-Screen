<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">


    <link rel="shortcut icon" href="../assets/imgs/blackscreenicon.ico" type="image/x-icon">
    <title>BlackScreen | Dashboards</title>
    <link rel="stylesheet" href="../css/dashPersona.css">
    <link rel="stylesheet" href="./../css/dashboards.css">
    <link rel="stylesheet" href="./../css/style.css" />
    <link rel="stylesheet" href="./../css/dashboardHomeAdm.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />



    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-statistics/7.8.3/simple-statistics.min.js"></script>
    <script src="../js/sessao.js"></script>
    <script src="./../js/alerta.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/regression/2.0.1/regression.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="../js/leaflet-heat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

</head>

<body>

    <div class="janela">
        <div class="header-left">
            <img src="../assets/imgs/blackscreenlogo.png" alt="BlackScreen">

            <div class="hello">
                <h3>Bem vindo, <br><span id="b_usuario">usuário</span>!</h3>
            </div>

            <div class="links">
                <div class="btn-nav-white">
                    <a href="dashboard.html">
                        <span class="material-symbols-outlined">
                            home
                        </span>
                        <h3>
                            Ínicio
                        </h3>
                    </a>
                </div>

                <div class="btn-nav-white">
                    <a href="../dashboard/logAlertas.html">
                        <span class="material-symbols-outlined">
                            notifications
                        </span>
                        <h3>
                            Alertas
                        </h3>
                    </a>
                </div>

                <div class="btn-nav-white">
                    <a href="../dashboard/atm.html">
                        <span class="material-symbols-outlined">
                            local_atm
                        </span>
                        <h3>
                            ATMs
                        </h3>
                    </a>
                </div>

                <div class="btn-nav-white">
                    <a href="../dashboard/cadastroComponentes.html">
                        <span class="material-symbols-outlined">
                            health_and_safety
                        </span>
                        <h3>
                            Componentes
                        </h3>
                    </a>
                </div>



                <div class="btn-nav">
                    <a href="../dashLukas/persona.html">
                        <span class="material-symbols-outlined">
                            signal_cellular_alt
                        </span>
                        <h3>
                            Persona
                        </h3>
                    </a>
                </div>





                <div class="btn-nav-white">
                    <a href="../dashboard/insight.html">
                        <span class="material-symbols-outlined">
                            search_insights
                        </span>
                        <h3>
                            Insights
                        </h3>
                    </a>
                </div>

                <div class="btn-nav-white">
                    <a href="../dashboard/perfil.html">
                        <span class="material-symbols-outlined">
                            account_circle
                        </span>
                        <h3>
                            Meu Perfil
                        </h3>
                    </a>
                </div>
            </div>
            <div class="btn-logout" onclick="limparSessao()">
                <h3>Sair</h3>
            </div>

        </div>

        <div class="help-desk content">

            <div class="metrics-container container_Header">

                <div class="perosna-kpi">
                    <span class="material-symbols-outlined icon_kpi"><svg xmlns="http://www.w3.org/2000/svg"
                            height="48px" viewBox="0 -960 960 960" width="48px" fill="#000">
                            <path
                                d="m24-112 456-789 456 789H24Zm140-81h632L480-740 164-193Zm319.86-50q13.72 0 22.93-9.37 9.21-9.37 9.21-22.79 0-12.42-9.39-22.13-9.39-9.71-23.1-9.71-12.72 0-22.61 9.66-9.9 9.67-9.9 22.52 0 13.42 10.07 22.62 10.07 9.2 22.79 9.2ZM455-348h57v-216h-57v216Zm25-119Z" />
                        </svg></span>
                    <div class="metric-info">
                        <h3>Alerta Por Componente</h3>
                        <div class="classCompontes">

                        </div>
                    </div>
                </div>

                <div class="perosna-kpi">
                    <span class="material_color_kpi material-symbols-outlined icon_kpi"><svg
                            xmlns="http://www.w3.org/2000/svg" height="48px" viewBox="0 -960 960 960" width="48px"
                            fill="#fff">
                            <path
                                d="M195-124v-91h64l78-254q9-30 32.46-48 23.45-18 54.54-18h113q30.71 0 53.86 18Q614-499 624-469l77 254h65v91H195Zm162-91h247l-69.5-229H425l-68 229Zm78-450v-212h91v212h-91Zm272 115-65-65 150-150 64 65-149 150Zm61 195v-91h211v91H768ZM253-550 104-700l64-65 151 150-66 65ZM-19-355v-91h212v91H-19Zm499 140Z" />
                        </svg></span>
                    <div class="metric-info">
                        <h3>Chamado Abertos</h3>
                        <div class="classCompontes_alertas"></div>
                    </div>
                </div>

                <div class="perosna-kpi">
                    <span class="atm_color material_color_kpi material-symbols-outlined icon_kpi atm"><svg
                            fill="#000000" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg"
                            xmlns:xlink="http://www.w3.org/1999/xlink" height="48px" viewBox="0 0 60 60" width="48px"
                            xml:space="preserve">
                            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                            <g id="SVGRepo_iconCarrier">
                                <g>
                                    <g>
                                        <path
                                            d="M59,36h-1V1c0-0.6-0.4-1-1-1H3C2.4,0,2,0.4,2,1v35H1c-0.6,0-1,0.4-1,1v13c0,0.6,0.4,1,1,1h10v-2H2V38h1h54h1v11H33v2h26 c0.6,0,1-0.4,1-1V37C60,36.4,59.6,36,59,36z M4,36V2h52v34H4z">
                                        </path>
                                        <path
                                            d="M34,6H7C6.4,6,6,6.4,6,7v24c0,0.6,0.4,1,1,1h27c0.6,0,1-0.4,1-1V7C35,6.4,34.6,6,34,6z M33,24h-7V8h7V24z M24,8v16H8V8H24 z M8,30v-4h25v4H8z">
                                        </path>
                                        <path
                                            d="M35,44v-2h-5H14H9v2h4v15c0,0.6,0.4,1,1,1h16c0.6,0,1-0.4,1-1V44H35z M25,44c0,1.1-0.9,2-2,2h-2c-1.1,0-2-0.9-2-2H25z M29,58H15V44h2c0,2.2,1.8,4,4,4h2c2.2,0,4-1.8,4-4h2V58z">
                                        </path>
                                        <path
                                            d="M53,6H39c-0.6,0-1,0.4-1,1v6c0,0.6,0.4,1,1,1h14c0.6,0,1-0.4,1-1V7C54,6.4,53.6,6,53,6z M52,12H40V8h12V12z">
                                        </path>
                                        <rect x="39" y="17" width="2" height="2"></rect>
                                        <rect x="43" y="17" width="2" height="2"></rect>
                                        <rect x="47" y="17" width="2" height="2"></rect>
                                        <rect x="51" y="17" width="2" height="2"></rect>
                                        <rect x="39" y="21" width="2" height="2"></rect>
                                        <rect x="43" y="21" width="2" height="2"></rect>
                                        <rect x="47" y="21" width="2" height="2"></rect>
                                        <rect x="51" y="21" width="2" height="2"></rect>
                                        <rect x="39" y="25" width="2" height="2"></rect>
                                        <rect x="43" y="25" width="2" height="2"></rect>
                                        <rect x="47" y="25" width="2" height="2"></rect>
                                        <rect x="51" y="25" width="2" height="2"></rect>
                                        <rect x="39" y="29" width="2" height="2"></rect>
                                        <rect x="43" y="29" width="2" height="2"></rect>
                                        <rect x="47" y="29" width="2" height="2"></rect>
                                        <rect x="51" y="29" width="2" height="2"></rect>
                                        <rect x="37" y="42" width="4" height="2"></rect>
                                        <rect x="43" y="42" width="4" height="2"></rect>
                                        <path d="M18,53h-2v3c0,0.6,0.4,1,1,1h3v-2h-2V53z"></path>
                                        <path d="M26,55h-2v2h3c0.6,0,1-0.4,1-1v-3h-2V55z"></path>
                                        <rect x="28" y="11" width="3" height="2"></rect>
                                        <rect x="28" y="15" width="3" height="2"></rect>
                                        <rect x="28" y="19" width="3" height="2"></rect>
                                        <path
                                            d="M14,21h1v1h2v-1h1c1.2,0,2-0.8,2-2v-2c0-1.2-0.8-2-2-2h-4v-2h4v1h2v-1c0-1.2-0.8-2-2-2h-1v-1h-2v1h-1c-1.2,0-2,0.8-2,2v2 c0,1.2,0.8,2,2,2h4v2h-4v-1h-2v1C12,20.2,12.8,21,14,21z">
                                        </path>
                                    </g>
                                </g>
                            </g>
                        </svg></span>
                    <div class="metric-info">
                        <h3>ATM Em Alerta</h3>
                        <div class="ATM_Alerta"></div>
                    </div>
                </div>

            </div>

            <h1>Jira</h1>

            <div class="charts-grid">

                <div class="container_jira container chart-card employees-by-role-bar full-width">
                    <h3>Chamados em Aberto no jira</h3>
                    <div class="chart-container">
                        <div class="kpi_metrica">
                        </div>
                    </div>
                </div>


                <div class="grafico chart-card employees-status">
                    <h3>Panorama Geral Tickets</h3>
                    <div class="chart-container">
                        <div id="myChart"></div>
                    </div>
                </div>
            </div>
            <h1>Componentes</h1>



            <div class="graficBarra charts-grid">

                <div class=" containerBarra container_jira container chart-card employees-by-role-bar full-width">
                    <h3> Metricas Componentes </h3>
                    <div>
                        <div id="kpi_metrica">
                            <div id="chart"></div>
                        </div>
                    </div>
                </div>


                <div class="chart-card employees-status">
                    <h3>Insights Gerado Por Inteligencia Artificial</h3>
                    <div class="iachart-container">
                        <div class="insights-container"></div>
                    </div>
                </div>
            </div>

            <h1>Gráfico de analise</h1>
            <div class=" graficoBolhacontainer  ">
                <div class=" graficoBolha ">
                    <div id="kpi_metrica-bubble">
                        <div id="bubble"></div>
                    </div>
                </div>
            </div>
            <div class="metrics-container container_bottum">

                <div class="perosna-kpi kpi-analitica">
                    <span class="material-symbols-outlined kpi-icon-analitica-mediana">
                    </span>
                    <div class="metric-info">
                        <h3>Extrapolação</h3>
                        <div class="classCompontes-analitica">

                        </div>
                    </div>
                </div>

                <div class="perosna-kpi kpi-analitica">
                    <span class="material-symbols-outlined kpi-icon-analitica-mediana-cpu">
                    </span>
                    <div class="metric-info">
                        <h3>Extrapolação</h3>
                        <div class="classCompontes-analitica-cpu">

                        </div>
                    </div>
                </div>

                <div class="perosna-kpi kpi-analitica">
                    <span class="material-symbols-outlined kpi-icon-analitica-mediana-rede">
                    </span>
                    <div class="metric-info">
                        <h3>Extrapolação</h3>
                        <div class="classCompontes-analitica-rede">

                        </div>
                    </div>
                </div>

            </div>
        </div>









        <div id="meuModalJira" class="modal-container" style="display: none;">
            <div class="modal-content">
                <span class="fechar" onclick="fecharModal()">&times;</span>
                <div id="conteudoModal"></div>
            </div>
        </div>
</body>

</html>

<script>





    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
    graficoPizza = null;

    let dataPadrao = {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
    };


    let dadosDoBucket = [];
    let bubble;


    async function kpiGraficoAnalise(
        ram,
        cpu,
        disco,
        perda,
        bytesRec,
        bytesEnv) {
        const kpi_icon_analitica = document.querySelector('.kpi-icon-analitica-mediana');
        const kpi_icon_analitica_mediana_cpu = document.querySelector('.kpi-icon-analitica-mediana-cpu');
        const kpi_icon_analitica_mediana_rede = document.querySelector('.kpi-icon-analitica-mediana-rede');

        kpi_icon_analitica_mediana_rede.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" height="48px" viewBox="0 -960 960 960" width="48px" fill="#FFFFFF"><path d="M177-259q-59-62-91-139.5T54-560q0-84 31.5-162.5T177-861l47 47q-49 51-77 116.5T119-560q0 72 28 137.5T224-306l-47 47Zm105-105q-39-38-60-89.5T201-560q0-55 21-106.5t60-89.5l46 45q-30 30-45.5 69T267-560q0 43 15 81.5t46 68.5l-46 46Zm153 259v-360q-29-14-45-39t-16-56q0-45 30.5-76t75.5-31q45 0 76 31t31 76q0 31-16.5 56T526-465v360h-91Zm243-259-45-46q30-30 45.5-68.5T694-560q0-43-16-81.5T633-711l45-45q39 38 60.5 89.5T760-560q1 55-21 106t-61 90Zm105 105-47-47q49-51 78-116.5T843-560q0-72-29-137.5T736-814l46-47q59 60 92.5 138.5T908-560q0 84-33 161.5T783-259Z"/></svg>`
        kpi_icon_analitica_mediana_cpu.innerHTML =``

        kpi_icon_analitica.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" height="48px" viewBox="0 -960 960 960" width="48px" fill="#FFFFFF"><path d="M380-380v-199h199v199H380Zm57-57h85v-85h-85v85ZM345-88v-90h-76q-35.78 0-63.39-27.61T178-269v-76H88v-68.33h90v-137.34H88V-619h90v-76q0-36.19 27.61-64.09Q233.22-787 269-787h76v-85h68.33v85h137.34v-85H619v85h76q36.19 0 64.09 27.91Q787-731.19 787-695v76h85v68.33h-85v137.34h85V-345h-85v76q0 35.78-27.91 63.39Q731.19-178 695-178h-76v90h-68.33v-90H413.33v90H345Zm350-181v-426H269v426h426ZM480-480Z"/></svg>`


        const classCompontes_analitica = document.querySelector('.classCompontes-analitica');
        classCompontes_analitica.innerHTML = "";

        const classCompontes_analitica_cpu = document.querySelector('.classCompontes-analitica-cpu');
        classCompontes_analitica_cpu.innerHTML="";
        fetch("/componentes/buscarValoresComponentes", {
            method: "GET"
        }).then(Response => {
            return Response.json();
        }).then(respostaBDComponentes => {

            medianaRam = ss.median(ram)
            medianaCpu = ss.median(cpu)
            medianaDisco = ss.median(disco)
            medianaBytesPerca = ss.median(perda)
            medianaBytesReceb = ss.median(bytesRec)
            medianaBytesEnviado = ss.median(bytesEnv)




            respostaBDComponentes.forEach(componentesBanco => {

                nome_componente = componentesBanco.Nome_Componente

                console.log(componentesBanco)
                if (nome_componente === "RAM") {
                    valorRamParametrizado = parseFloat(componentesBanco.Valor_Parametrizado)

                    porcentagem = ((medianaRam - valorRamParametrizado) / medianaRam) * 100;
                    refatoradoPorcentagem = porcentagem.toFixed(2)

                    if (refatoradoPorcentagem == valorRamParametrizado) {
                        classCompontes_analitica.innerHTML = `
                        <div class="infoMetrica_KPI" style="color:green;">
                        Porcentagem Ram: ${refatoradoPorcentagem}%  <svg xmlns="http://www.w3.org/2000/svg" height="48px" viewBox="0 -960 960 960" width="48px" fill="#75FB4C"><path d="m124-222-65-64 317-316 167 167 204-207H628v-92h274v275h-91v-117L542-305 375-472 124-222Z"/></svg></div>
                    `
                    } else {
                        classCompontes_analitica.innerHTML = `
                      <div class="infoMetrica_KPI" style="color:red;">
                        Porcentagem Ram: ${refatoradoPorcentagem}%  <svg xmlns="http://www.w3.org/2000/svg" height="48px" viewBox="0 -960 960 960" width="48px" fill="#EA3323"><path d="M628-222v-91h119L543-519 376-352 59-669l65-65 251 252 167-167 269 270v-116h91v273H628Z"/></svg></div>
                        `
                    }
                    
                }
                
                if(nome_componente === "CPU"){
                    valorCpuParametrizado = parseFloat(componentesBanco.Valor_Parametrizado)
                    porcentagemCpu = ((medianaCpu - valorCpuParametrizado)/medianaCpu) *100;
                    refatoracaoCPU = porcentagemCpu.toFixed(2)
                    
                    if(refatoracaoCPU == valorCpuParametrizado){
                            console.log(refatoracaoCPU)
                            classCompontes_analitica_cpu.innerHTML=`
                            <div class="infoMetrica_KPI" style="color:green;">
                        Porcentagem CPU: ${refatoracaoCPU}%  <svg xmlns="http://www.w3.org/2000/svg" height="48px" viewBox="0 -960 960 960" width="48px" fill="#75FB4C"><path d="m124-222-65-64 317-316 167 167 204-207H628v-92h274v275h-91v-117L542-305 375-472 124-222Z"/></svg></div>`
                        }else{
                            classCompontes_analitica_cpu.innerHTML=`
                            <div class="infoMetrica_KPI" style="color:red;">
                        Porcentagem CPU: ${refatoracaoCPU}%  <svg xmlns="http://www.w3.org/2000/svg" height="48px" viewBox="0 -960 960 960" width="48px" fill="#EA3323"><path d="M628-222v-91h119L543-519 376-352 59-669l65-65 251 252 167-167 269 270v-116h91v273H628Z"/></svg></div>
                            `
                        }
                    }




            });

        })

    }





    async function lerCsvBucket() {
        const bucketUrl = "https://client-blackscreen.s3.us-east-1.amazonaws.com";
        const pasta = "Maquina/";



        const responseList = await fetch(`${bucketUrl}?list-type=2&prefix=${pasta}`);
        if (!responseList.ok) throw new Error("Erro ao listar bucket");

        const xmlText = await responseList.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "text/xml");

        const conteudos = xmlDoc.getElementsByTagName("Contents");
        const urlsParaBaixar = [];

        for (let i = 0; i < conteudos.length; i++) {
            const key = conteudos[i].getElementsByTagName("Key")[0].textContent;
            if (key.endsWith(".csv")) {
                urlsParaBaixar.push(`${bucketUrl}/${key}`);
            }
        }

        const requests = urlsParaBaixar.map(url => fetch(url).then(res => res.text()));
        const conteudosClient = await Promise.all(requests);
        let resultadoFinal = [];

        conteudosClient.forEach(respostaBucket => {
            var csv = respostaBucket.trim().split("\n");
            var headers = csv[0].split(";");
            for (var i = 1; i < csv.length; i++) {
                var obj = {};
                var linhaAtual = csv[i].replace('\r', '').split(";");

                if (linhaAtual.length === headers.length) {
                    for (var j = 0; j < headers.length; j++) {
                        var chave = headers[j].trim();
                        var valor = linhaAtual[j];
                        obj[chave] = valor;
                    }
                    resultadoFinal.push(obj);
                }
            }
        });

        dadosDoBucket = resultadoFinal;
        const ram = dadosDoBucket.map(item => parseFloat(item.ram));
        const cpu = dadosDoBucket.map(item => parseFloat(item.cpu));
        const disco = dadosDoBucket.map(item => parseFloat(item.disco));
        const perda = dadosDoBucket.map(item => parseFloat(item.pacotes_perdidos));
        const bytesRec = dadosDoBucket.map(item => parseFloat(item.bytes_recebidos));
        const bytesEnv = dadosDoBucket.map(item => parseFloat(item.bytes_enviados));


        const montarSerie = (arrayX, arrayY) => {
            return arrayX.map((valorX, index) => [valorX, arrayY[index]]);
        };

        if (bubble) {
            bubble.destroy();

        }
        var options = {
            series: [
                {
                    name: "CPU (vs RAM)",
                    data: montarSerie(cpu, ram)
                }

            ],
            chart: {
                width: 1450,
                height: 700,

                type: 'scatter',
                zoom: {
                    enabled: true,
                    type: 'xy'
                }
            },
            xaxis: {
                title: {
                    text: 'Uso da CPU em %'
                },
                tickAmount: 10,
                labels: {
                    formatter: function (val) {
                        return parseFloat(val).toFixed(1)
                    }
                }
            },
            yaxis: {
                title: {
                    text: 'Uso de RAM em %'
                },
                tickAmount: 10
            },
            markers: {
                size: 5,
                fillOpacity: 0.6,
                strokeWidth: 0
            },
            tooltip: {
                shared: false,
                intersect: true,
                y: {
                    formatter: function (val) {
                        return val + "% (RAM)"
                    }
                }
            },
            legend: {
                position: 'top',
                horizontalAlign: 'left'
            }
        };


        bubble = new ApexCharts(document.querySelector("#bubble"), options);

        bubble.render();

        await kpiGraficoAnalise(
            ram,
            cpu,
            disco,
            perda,
            bytesRec,
            bytesEnv
        )
    }


    function buscarPorComponenteDash() {
        fetch('http://98.83.124.125:8080/chamadosJira', {
            method: "GET"
        }).then(Response => {
            return Response.json();
        }).then(respostaJira => {

            let ArrayChamados = [];
            const respostaDoJira = respostaJira.issues;

            const hoje = new Date();

            const inicioSemanaAtual = new Date(hoje);
            inicioSemanaAtual.setDate(hoje.getDate() - hoje.getDay());
            inicioSemanaAtual.setHours(0, 0, 0, 0);

            const inicioSemanaAnterior = new Date(inicioSemanaAtual);
            inicioSemanaAnterior.setDate(inicioSemanaAtual.getDate() - 7);

            const fimSemanaAnterior = new Date(inicioSemanaAtual);
            fimSemanaAnterior.setMilliseconds(-1);

            respostaDoJira.forEach(dadosJira => {
                let nomeDoAtm = dadosJira.fields.description?.content?.[0]?.content?.[0]?.text || "Indefinido";

                let dataDeCriacao = new Date(dadosJira.fields.created);
                let nomeDoComponente = dadosJira.fields.summary;
                let status = dadosJira.fields.status.name;


                if (nomeDoComponente.toLowerCase().includes("testando via java")) return;

                if (nomeDoComponente.toLowerCase().includes("ram")) nomeDoComponente = 'RAM';
                else if (nomeDoComponente.toLowerCase().includes("cpu")) nomeDoComponente = 'CPU';
                else if (nomeDoComponente.toLowerCase().includes("disco")) nomeDoComponente = 'DISCO';
                else if (nomeDoComponente.toLowerCase().includes("rede")) nomeDoComponente = 'REDE';
                else return;
                let periodo = null;
                if (dataDeCriacao >= inicioSemanaAtual && dataDeCriacao <= hoje) {
                    periodo = 'atual';
                } else if (dataDeCriacao >= inicioSemanaAnterior && dataDeCriacao <= fimSemanaAnterior) {
                    periodo = 'anterior';
                }

                if (periodo) {
                    ArrayChamados.push({
                        componente: nomeDoComponente,
                        periodo: periodo,
                        status: status
                    });
                }
            });

            const contagemPorComponente = {};

            ArrayChamados.forEach(chamado => {

                if (!contagemPorComponente[chamado.componente]) {
                    contagemPorComponente[chamado.componente] = { atual: 0, anterior: 0 };
                }

                if (chamado.periodo === 'atual') {
                    contagemPorComponente[chamado.componente].atual++;
                } else if (chamado.periodo === 'anterior') {
                    contagemPorComponente[chamado.componente].anterior++;
                }
            });

            const componentes = Object.keys(contagemPorComponente);
            const dadosSemanaAtual = componentes.map(comp => contagemPorComponente[comp].atual);
            const dadosSemanaAnterior = componentes.map(comp => contagemPorComponente[comp].anterior);

            var options = {
                series: [{
                    name: 'Semana Atual',
                    data: dadosSemanaAtual
                }, {
                    name: 'Semana Anterior',
                    data: dadosSemanaAnterior
                }],

                chart: {
                    type: 'bar',
                    height: 430,
                    background: '#f5f5f5',
                    borderRadius: '20px',
                    color: '#000'
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        dataLabels: { position: 'top' },
                    }
                },
                dataLabels: {
                    enabled: false,
                    offsetX: -6,
                    style: { fontSize: '15px', colors: ['#fff'] }
                },
                stroke: { show: true, width: 1, colors: ['#fff'] },
                tooltip: { shared: true, intersect: false },
                xaxis: {
                    titel: {
                        text: 'Componentes',
                        style: {
                            color: '#000',
                            fontSize: '15px',
                            fontWeight: 600,
                            background: '#000'

                        }
                    }, categories: componentes
                },
                legend: { position: 'top', horizontalAlign: 'right' },
                colors: ['#004076', '#5C9BD5']


            }




            const chartElement = document.querySelector("#chart");
            if (chartElement) {
                chartElement.innerHTML = "";
                var chart = new ApexCharts(chartElement, options);
                chart.render();
            }
            if (typeof enviarDadosParaIA === 'function') {
                enviarDadosParaIA(ArrayChamados, componentes, dadosSemanaAtual, dadosSemanaAnterior);
            }

        }).catch(error => {
            console.error("Erro na requisição ou processamento:", error);
        });


    }
    /* function enviarDadosParaIA(dadosJira, componentes, dadosSemanaAtual, dadosSemanaAnterior) {
            fetch("http://localhost:3333/gemini/prompt", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    dadosJira: dadosJira,
                    componentes: componentes,
                    dadosSemanaAtual: dadosSemanaAtual,
                    dadosSemanaAnterior: dadosSemanaAnterior
                })
            })
                .then(response => response.json())
                .then(resultado => {
                    exibirInsights(resultado.insights);
                })
                .catch(error => {
                    console.error("Erro ao buscar insights do gemini", error);
                });
        }
        function exibirInsights(insights) {
            const container = document.querySelector('.insights-container');
            if (container) {
                container.innerHTML = `
                <div>
                    <h1>
                        Análise Técnica 
                    </h1>
                    <div class="insights_ia">
                        ${insights}
                    </div>
                    </div>
                    <h3>Todos os insights gerado por IA devem ser seguidos com responsábilidade e não dispensa a analise de um especialista. </h3>
            `;
            }
        }
       */

    function buscarDataEHoraChamados() {

        fetch('http://98.83.124.125:8080/chamadosJira', {
            method: "GET"
        }).then(Response => {
            return Response.json();
        }).then(respostaData => {

            const chamadoHora = respostaData.issues;


            const dataEHoraFormatada = new Intl.DateTimeFormat('pt-BR', dataPadrao);


            const classCompontes_alertas = document.querySelector('.classCompontes_alertas');


            const kpi_metrica = document.querySelector('.kpi_metrica');

            kpi_metrica.innerHTML = '';
            classCompontes_alertas.innerHTML = ""
            let totalDeChamadosAbertos = 0;
            let totalDeChamadosConcluidos = 0;
            let totalDeChamadosReabertos = 0;


            const chartElement = document.querySelector('#myChart');

            let statusAtual;
            let cores;

            chamadoHora.forEach(chamadosHora => {

                statusAtual = chamadosHora.fields.status.name;
                const nomeComponenteAlerta = chamadosHora.fields.summary;

                if (statusAtual === "Concluído") {
                    totalDeChamadosConcluidos++
                }

                const stringCriacao = chamadosHora.fields.created;
                const stringAlteracao = chamadosHora.fields.updated;


                const dataAtual = new Date();
                const objDataCriacao = new Date(stringCriacao);
                const objDataAtualizacao = new Date(stringAlteracao);
                const dataCriacao = dataEHoraFormatada.format(objDataCriacao);
                const dataUpdate = dataEHoraFormatada.format(objDataAtualizacao);

                const compHora = dataAtual - objDataCriacao;
                const milissegundosPorDia = 1000 * 60 * 60 * 24;
                const tempo = 5 * 60 * 1000;

                idMaquina = chamadosHora.fields.description.content[0].content[0].text;
                cores = [
                    'rgb(255,0,0)',

                    'rgb(0, 64, 118)'
                ];

                if (statusAtual == "Aberto" || statusAtual == "Reaberto") {

                    if (compHora > tempo) {
                        const emDias = compHora / milissegundosPorDia;
                        const diasInteiros = Math.floor(emDias);

                        const chamadoDiv = document.createElement('div');
                        chamadoDiv.className = 'chamado-item';


                        chamadoDiv.innerHTML = `
                          <div class="info">
                            <div class="card-jira"role="button" onclick="abrirModal('${idMaquina}','${nomeComponenteAlerta}' , '${statusAtual}', '${diasInteiros}', '${dataCriacao}', '${dataUpdate}')">
                                <div class="chamado-titulo">${nomeComponenteAlerta} <svg xmlns="http://www.w3.org/2000/svg" height="48px" viewBox="0 -960 960 960" width="48px" fill="#fff"><path d="M210-160v-60h61l84-277q6-19 21.5-31t35.5-12h136q20 0 35.5 12t21.5 31l84 277h61v60H210Zm125-60h290l-78-260H413l-78 260Zm115-440v-180h60v180h-60Zm235 98-43-43 128-127 42 42-127 128Zm55 192v-60h180v60H740ZM275-562 148-690l42-42 128 127-43 43ZM40-370v-60h180v60H40Zm440 150Z"/></svg></div>
                            <p>${idMaquina}</p>
                            </div>
                          </div>
                          `;
                        kpi_metrica.appendChild(chamadoDiv);

                        if (statusAtual == "Aberto") {
                            totalDeChamadosAbertos++
                        } else if (statusAtual == "Reaberto") {
                            totalDeChamadosReabertos++;
                        }


                    }
                }

            });
            if (statusAtual == "Concluído" || statusAtual == "Aberto" || statusAtual == "Reaberto") {
                chamadosTotais = 0;
                chamadosTotais += totalDeChamadosReabertos;
                chamadosTotais += totalDeChamadosAbertos;


                let chamadosGrafico =
                    [
                        chamadosTotais,
                        totalDeChamadosConcluidos
                    ]
                if (graficoPizza) {
                    graficoPizza.destroy();
                }

                var options = {
                    series: [chamadosGrafico[0], chamadosGrafico[1]],

                    chart: {
                        type: 'donut',
                        width: '380px',
                        height: '280px',
                        background: '# f5f5f5',
                        color: '#fff'
                    },

                    labels: ['Abertos e Reabertos', 'Concluídos'],
                    colors: cores,
                    legend: {
                        position: 'top'
                    },

                    title: {
                        text: 'Status dos Chamados',
                        align: 'center'
                    },

                    plotOptions: {
                        pie: {
                            donut: {
                                size: '65%',

                                labels: {
                                    show: true,
                                    total: {
                                        show: true,
                                        label: 'Total',
                                        fontSize: '15px',
                                        formatter: function (w) {
                                            return w.globals.series.reduce((a, b) => a + b, 0);
                                        }
                                    }
                                }
                            }
                        }
                    },

                    responsive: [{
                        breakpoint: 480,
                        options: {
                            chart: {
                                width: 200,
                                color: '#fff'
                            },
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }]
                };


                graficoPizza = new ApexCharts(chartElement, options);
                graficoPizza.render();

            }




            if (totalDeChamadosAbertos === 0 && totalDeChamadosReabertos === 0) {

                classCompontes_alertas.innerHTML = '<p class="sem-alertas">Nenhum chamado em alerta no momento.</p>';
            }
            else {
                totalDeChamadosAbertos += totalDeChamadosReabertos;
                classCompontes_alertas.innerHTML += `
            <div class="tituloAlerta">chamado(s) sem solução</div>
            <div class="infoAlerta">${totalDeChamadosAbertos}</div>
            `
            }

        })

    };
    function abrirModal(nomeComponenteAlerta, nome, status, dias, criacao, update, idMaquina) {
        const modal = document.getElementById('meuModalJira');
        const conteudo = document.getElementById('conteudoModal');
        const divSvg = document.querySelector('.divSvg')
        fetch('http://98.83.124.125:8080/chamadosJira', {
            method: 'PUTT',
            body: [,

            ]
        })
        let valorSvg = "";


        conteudo.innerHTML = `
        <div class="divSvg">${nome} ${valorSvg}</div>
        <p>${nomeComponenteAlerta}</p>
        <div class="chamado-detalhes">
            <p><strong>Status:</strong> ${status}</p>
            <p><strong>Dias em aberto:</strong> ${dias} dia(s)</p>
            <p><strong>Criado em:</strong> ${criacao}</p>
            <p><strong>Atualizado em:</strong> ${update}</p>
        </div>
    `;

        modal.style.display = 'flex';

    }
    function fecharModal() {
        document.getElementById('meuModalJira').style.display = 'none';
        window.location.reload()
    }

    window.onclick = function (event) {
        const modal = document.getElementById('meuModalJira');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    function buscandoComponenteJiraKpi() {
        fetch('http://98.83.124.125:8080/chamadosJira', {
            method: "GET"

        }).then(Response => {

            return Response.json();

        }).then(resposta => {
            const chamados = resposta.issues;
            let cpu = 0;
            let ram = 0;
            let disco = 0;
            let rede = 0;
            let qtdAtm = 0;
            let atmId = []
            let componentes_nome = document.querySelector('.classCompontes');
            let ATM_Alerta = document.querySelector('.ATM_Alerta')
            chamados.forEach(chamado => {

                statusNome = chamado.fields.status.name;
                nomeComponente = chamado.fields.summary;
                chave = chamado.key;
                idMaquina = chamado.fields.description.content[0].content[0].text;

                idAnterio = "";
                if (idMaquina.includes("ID ATM:")) {
                    if (!atmId.includes(idMaquina)) {
                        atmId.push(idMaquina);


                        if (!idMaquina == idAnterio && statusNome.includes("Aberto")) {
                            qtdAtm++;
                            idAnterio = idMaquina;


                        } else if (!idMaquina == idAnterio && statusNome.includes("Reaberto")) {
                            qtdAtm++;
                            idAnterio = idMaquina;


                        }
                    }
                }

                if (statusNome == "Aberto" || statusNome == "Itens Pendentes") {
                    if (nomeComponente.includes("CPU") || nomeComponente.includes('cpu') || nomeComponente.includes('Cpu')) {
                        cpu++
                    }
                    else if (nomeComponente.includes("RAM") || nomeComponente.includes('ram') || nomeComponente.includes('Ram')) {
                        ram++
                    }
                    else if (nomeComponente.includes("DISCO") || nomeComponente.includes('disco') || nomeComponente.includes('Disco')) {
                        disco++
                    } else if (nomeComponente.includes("Rede") || nomeComponente.includes('REDE') || nomeComponente.includes('rede')) {
                        rede++
                    }


                }

                let ranking = [
                    { nome: 'CPU', valor: cpu, classe: 'componente1' },
                    { nome: 'RAM', valor: ram, classe: 'componente2' },
                    { nome: 'DISCO', valor: disco, classe: 'componente3' },
                    { nome: 'REDE', valor: rede, classe: 'componente4' }
                ];


                ranking.sort((a, b) => {
                    return b.valor - a.valor;
                });

                const container = document.querySelector('.classCompontes');

                container.innerHTML = '';


                for (const item of ranking) {
                    if (item.valor === 0) {
                        container.innerHTML += `
                        <h4 class="componente ${item.classe}">${item.nome}: ${item.valor}<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#75FB4C"><path d="M378-246 154-470l43-43 181 181 384-384 43 43-427 427Z"/></svg> </h4> `
                    } else if (item.valor < 10) {
                        container.innerHTML += `
                    <h4 class="componente ${item.classe}">${item.nome}: ${item.valor}  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#FFFF55"><path d="M400-240q-33 0-56.5-23.5T320-320v-50q-57-39-88.5-100T200-600q0-117 81.5-198.5T480-880q117 0 198.5 81.5T760-600q0 69-31.5 129.5T640-370v50q0 33-23.5 56.5T560-240H400Zm0-80h160v-92l34-24q41-28 63.5-71.5T680-600q0-83-58.5-141.5T480-800q-83 0-141.5 58.5T280-600q0 49 22.5 92.5T366-436l34 24v92Zm0 240q-17 0-28.5-11.5T360-120v-40h240v40q0 17-11.5 28.5T560-80H400Zm80-520Z"/></svg></h4>
                `;
                    } else if (item.valor >= 11) {
                        container.innerHTML += `
                    <h4 class="componente ${item.classe}">${item.nome}: ${item.valor}<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#EA3323"><path d="M200-160v-80h64l79-263q8-26 29.5-41.5T420-560h120q26 0 47.5 15.5T617-503l79 263h64v80H200Zm148-80h264l-72-240H420l-72 240Zm92-400v-200h80v200h-80Zm238 99-57-57 142-141 56 56-141 142Zm42 181v-80h200v80H720ZM282-541 141-683l56-56 142 141-57 57ZM40-360v-80h200v80H40Zm440 120Z"/></svg> </h4>
                `;
                    }
                }

            });

            if (qtdAtm > 0) {

                ATM_Alerta.innerHTML += `
                <h4 class="atms">ATM(S):  ${qtdAtm}</h4>
                `
            } else {
                ATM_Alerta.innerHTML += `
                <h4 class="atms"><strong>Nenhum ATM com alerta</strong></h4>
                `
            }

        })
    };
    setTimeout(lerCsvBucket, 2000)
    setTimeout(buscarDataEHoraChamados, 2000);
    setTimeout(buscandoComponenteJiraKpi, 2000);
    setTimeout(buscarPorComponenteDash, 2000);
    setTimeout(lerCsvBucket, 2000)   
</script>