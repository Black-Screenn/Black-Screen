<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/imgs/blackscreenicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlackScreen | Visão Detalhada</title>
    
    <link rel="stylesheet" href="./../css/dashboards.css">
    <link rel="stylesheet" href="./../css/dashboardLista.css">
    <link rel="stylesheet" href="./../css/dashboardFunc.css">
    <link rel="stylesheet" href="./../css/estilo.css" />
    <script src="../js/sessao.js"></script>
    <script src="./../js/alerta.js"></script>

    <link rel="preconnect" href="https://fonts.gstatic.com">
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    
    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <style>
 
    </style>
</head>
<body>   
     <div class="janela">

            <div class="header-left">
                <img
                    src="../assets/imgs/blackscreenlogo.png"
                    alt="BlackScreen"
                />

                <div class="hello">
                    <h3>
                        Bem vindo, <br /><span id="b_usuario">usuário</span>!
                    </h3>
                </div>

                <div class="links">
                    <div class="btn-nav-white">
                        <a href="../dashboard/dashboardTecnico.html">
                            <span class="material-symbols-outlined">home</span>
                            <h3>Ínicio</h3>
                        </a>
                    </div>
                    <div class="btn-nav-white">
                        <a href="../dashLukas/persona.html">
                            <span class="material-symbols-outlined"
                                >signal_cellular_alt</span
                            >
                            <h3>Métricas</h3>
                        </a>
                    </div>
                    <div class="btn-nav">
                        <a href="../dashboardEdu/lista.html">
                            <span class="material-symbols-outlined"
                                >brightness_alert</span
                            >
                            <h3>Alertas</h3>
                        </a>
                    </div>
                    <div class="btn-nav-white">
                        <a href="../dashboard/perfil.html">
                            <span class="material-symbols-outlined"
                                >account_circle</span
                            >
                            <h3>Meu Perfil</h3>
                        </a>
                    </div>
                    <div class="btn-logout" onclick="limparSessao()">
                        <h3>Sair</h3>
                    </div>
                </div>
            </div>

        <div class="content">

            <div class="js">
                <canvas id="grafico"></canvas>
            </div>

            <div class="listaAtm">
                <div class="header">
                    Lista de Chamados do Jira
                    <select name="Componente" id="filtro_componente" onchange="carregarChamados()">
                        <option value="sem_filtro">Filtrar por Componente</option>
                        <option value="filtro_cpu">CPU</option>
                        <option value="filtro_ram">RAM</option>
                        <option value="filtro_disco">Disco</option>
                        <option value="filtro_rede">Rede</option>
                    </select>
                </div>
                <div class="lista">
                    <div class="lista-header">
                        <p class="atm">Código Chamado</p>
                        <p class="address">Componente</p>
                        <p class="country">Data e Hora</p>
                        <p class="alertas">Link do Chamado</p>
                    </div>
                    <div class="lista-content">
                    </div>
                </div>
            </div>
        </div>

    </div>
</body>

<script>
    var cpu = 0;
    var ram = 0;
    var disco = 0;
    var rede = 0;

    window.onload = () => {
        somandoComponenteAlertaJiraKpi();
        plotarGrafico();
        carregarChamados();
    };

    console.log(sessionStorage.IDMAQUINAESCOLHIDA)

    function somandoComponenteAlertaJiraKpi() {
        fetch('http://98.83.124.125:8080/chamadosJira', {
            method: "GET"

        }).then(Response => {

            return Response.json();

        }).then(resposta => {
            const chamados = resposta.issues;
            let componentes_nome = document.querySelector('.classCompontes');
            let ATM_Alerta = document.querySelector('.ATM_Alerta')
            chamados.forEach(chamado => {
                
                statusNome = chamado.fields.status.name;
                nomeComponente = chamado.fields.summary;
                chave = chamado.key;
                idMaquina = chamado.fields.description.content[0].content[0].text;
            
                if(sessionStorage.IDMAQUINAESCOLHIDA == idMaquina){
                    if (nomeComponente.includes("CPU")) {
                        cpu++
                    }
                    else if (nomeComponente.includes("RAM")) {
                        ram++
                    }
                    else if (nomeComponente.includes("DISCO")) {
                        disco++
                    }else if(nomeComponente.includes("Rede")){
                        rede++
                    }
                }
                //console.log(chamado)
            })
        })
    }

    function plotarGrafico() {
    console.log('iniciando plotagem do gráfico...');

    const grafico = document.getElementById('grafico').getContext('2d');

    let labels = ['CPU','RAM','Disco','Rede'];

    let dados = {
        labels: labels,
        datasets: [{
        data: [cpu,ram,disco,rede],
        borderWidth: 1
      }]
    };

    const config = {
      type: "bar",
      data: dados,
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Alertas por Componente'
          }
        }
      }
    };

    graficoAvisoPorComponente = new Chart (
        grafico,
        config
    )

  }
   
   function carregarChamados() {
        fetch('http://98.83.124.125:8080/chamadosJira', {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            }
        })
            .then(response => response.json() )
            .then(data => {
            const listaContent = document.querySelector(".lista-content");
            const chamados = data.issues;
            listaContent.innerHTML = ""
            if (chamados.length === 0) {
                listaContent.innerHTML = "<p style='padding: 20px; text-align: center;'>Nenhum Chamado no Jira.</p>";
                return;
            }
            chamados.forEach(chamado =>{
                const item = document.createElement("div");
                item.classList.add("lista-item");
                let componente = chamado.fields.summary;
                let chave = chamado.key;
                let hora = chamado.fields.created;
                let link = chamado.self;
                
                let sem_aviso = componente.substring(8);
                let componente_limpo = sem_aviso.split("|",1)

                let dia_hora_limpo = hora.split(/T|\./,2)

                var filtro = document.getElementById("filtro_componente").value

                if(filtro =="sem_filtro"){
                    item.innerHTML = `
                        
                        <p class="atm">${chave}</p>
                        <p class="address">${componente_limpo}</p>
                        <p class="country">${dia_hora_limpo}</p>
                        <p class="acao">
                            <a class="link" href="${link}"> Link Chamado </a> 
                        </p>
                    `;
                    listaContent.appendChild(item);
                } if(filtro == "filtro_cpu" && componente_limpo == "CPU"){
                        item.innerHTML = `
                        
                        <p class="atm">${chave}</p>
                        <p class="address">${componente_limpo}</p>
                        <p class="country">${dia_hora_limpo}</p>
                        <p class="acao">
                            <a class="link" href="${link}"> Link Chamado </a> 
                        </p>
                    `;
                    listaContent.appendChild(item);
                } if(filtro == "filtro_ram"){
                    if(componente_limpo = "RAM"){
                        item.innerHTML = `
                        
                        <p class="atm">${chave}</p>
                        <p class="address">${componente_limpo}</p>
                        <p class="country">${dia_hora_limpo}</p>
                        <p class="acao">
                            <a class="link" href="${link}"> Link Chamado </a> 
                        </p>
                    `;
                    listaContent.appendChild(item);
                    }
                } if(filtro == "filtro_disco"){
                    if(componente_limpo = "Disco"){
                        item.innerHTML = `
                        
                        <p class="atm">${chave}</p>
                        <p class="address">${componente_limpo}</p>
                        <p class="country">${dia_hora_limpo}</p>
                        <p class="acao">
                            <a class="link" href="${link}"> Link Chamado </a> 
                        </p>
                    `;
                    listaContent.appendChild(item);
                    }
                } if(filtro == "filtro_rede"){
                    if(componente_limpo = "Rede"){
                        item.innerHTML = `
                        
                        <p class="atm">${chave}</p>
                        <p class="address">${componente_limpo}</p>
                        <p class="country">${dia_hora_limpo}</p>
                        <p class="acao">
                            <a class="link" href="${link}"> Link Chamado </a> 
                        </p>
                    `;
                    listaContent.appendChild(item);
                    }
                }
            })
            })
                
    }
</script>