<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/imgs/blackscreenicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlackScreen | Lista Alertas</title>

    <link rel="stylesheet" href="./../css/dashboards.css">
    <link rel="stylesheet" href="./../css/dashboardLista.css">
    <link rel="stylesheet" href="./../css/dashboardFunc.css">
    <link rel="stylesheet" href="./../css/estilo.css" />
    <script src="../js/sessao.js"></script>
    <script src="./../js/alerta.js"></script>

    <link rel="preconnect" href="https://fonts.gstatic.com">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />

    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <style>

    </style>
</head>

<body>
    <div class="janela">
        <div class="header-left">
            <img src="../assets/imgs/blackscreenlogo.png" alt="BlackScreen">

            <div class="hello">
                <h3>Bem vindo, <br><span id="b_usuario">usuário</span>!</h3>
            </div>

            <div class="links">
                <div class="btn-nav">
                    <a href="../dashboard/dashboard.html">
                        <span class="material-symbols-outlined">
                            home
                        </span>
                        <h3>
                            Ínicio
                        </h3>
                    </a>
                </div>

                <div class="btn-nav-white">
                    <a href="../dashboard/logAlertas.html">
                        <span class="material-symbols-outlined">
                            notifications
                        </span>
                        <h3>
                            Alertas
                        </h3>
                    </a>
                </div>

                <div class="btn-nav-white">
                    <a href="../dashboard/atm.html">
                        <span class="material-symbols-outlined">
                            local_atm
                        </span>
                        <h3>
                            ATMs
                        </h3>
                    </a>
                </div>

                <div class="btn-nav-white">
                    <a href="../dashboard/cadastroComponentes.html">
                        <span class="material-symbols-outlined">
                            health_and_safety
                        </span>
                        <h3>
                            Componentes
                        </h3>
                    </a>
                </div>




                <div class="btn-nav-white">
                    <a href="../dashLukas/persona.html">
                        <span class="material-symbols-outlined">
                            signal_cellular_alt
                        </span>
                        <h3>
                            Persona
                        </h3>
                    </a>
                </div>




                <div class="btn-nav-white">
                    <a href="./insight.html">
                        <span class="material-symbols-outlined">
                            search_insights
                        </span>
                        <h3>
                            Insights
                        </h3>
                    </a>
                </div>

                <div class="btn-nav-white">
                    <a href="./perfil.html">
                        <span class="material-symbols-outlined">
                            account_circle
                        </span>
                        <h3>
                            Meu Perfil
                        </h3>
                    </a>
                </div>
            </div>

            <div class="btn-logout" onclick="limparSessao()">
                <h3>Sair</h3>
            </div>

        </div>

        <div class="content">
            <div class="listaAtm">
                <div class="header">
                    Lista de ATMs com alertas
                </div>
                <div class="lista">
                    <div class="lista-header">
                        
                        <p class="atm">Código ATM</p>
                        <p class="address">Endereço</p>
                        <p class="country">Cidade/UF</p>
                        <p class="alertas">Número de Alertas</p>
                        <p class="acao">Ver Mais</p>
                    </div>
                    <div class="lista-content">
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    let qtdAlertas = 0

    window.onload = async () => {
        await buscandoAlertasJiraKpi();
        await carregarATMs();
    };

    async function buscandoAlertasJiraKpi() {
        await fetch('http://98.83.124.125:8080/chamadosJira', {
            method: "GET"

        }).then(Response => {

            return Response.json();

        }).then(resposta => {
            const chamados = resposta.issues;
            let atmId = []
            let ATM_Alerta = document.querySelector('.ATM_Alerta')
            chamados.forEach(chamado => {

                let statusNome = chamado.fields.status.name;
                let chave = chamado.key;
                let idMaquina = chamado.fields.description.content[0].content[0].text;

                let idAnterio = idMaquina;
                if (idMaquina.includes("ID ATM:")) {
                    if (!atmId.includes(idMaquina)) {
                        atmId.push(idMaquina);
                        console.log(statusNome)
                        console.log(idMaquina)
                    }
                }

                

                if (idMaquina == idAnterio) {
                    qtdAlertas++;
                }else if (idMaquina != idAnterio) {
                    idAnterio = idMaquina;
                    console.log("Oi")
                    qtdAlertas = 0;
                }
            })
            console.log(qtdAlertas)
        })
    }

    function carregarATMs() {
        fetch("/caixas/listar", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "Fk_Empresa": sessionStorage.FK_EMPRESA
            }
        })
            .then(response => response.json())
            .then(data => {
                atmsData = data;
                const listaContent = document.querySelector(".lista-content");
                listaContent.innerHTML = "";

                if (data.length === 0) {
                    listaContent.innerHTML = "<p style='padding: 20px; text-align: center;'>Nenhum ATM cadastrado.</p>";
                    return;
                }

                data.forEach(atm => {
                    const item = document.createElement("div");
                    item.classList.add("lista-item");

                    const endereco = `${atm.Logradouro}, ${atm.Bairro}`;
                    const cidadeUF = `${atm.Cidade}/${atm.UF}`;

                    item.innerHTML = `
                        
                        <p class="atm">${atm.codigoCaixa}</p>
                        <p class="address">${endereco}</p>
                        <p class="country">${cidadeUF}</p>
                        <p class="alertas" id="comp_count_${atm.id}">${qtdAlertas}</p>
                        <p class="acao">
                            <a class="link" href="./visao_detalhada.html"> Visão Detalhada </a> 
                        </p>
                    `;
                    listaContent.appendChild(item);
                    
                });
            })
            .catch(error => {
                console.error("Erro ao carregar ATMs:", error);
            });
    }
</script>