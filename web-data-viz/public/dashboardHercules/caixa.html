<!doctype html>
<html lang="pt-br">
    <head>
        <link
            rel="shortcut icon"
            href="../assets/imgs/blackscreenicon.ico"
            type="image/x-icon"
        />
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale-1.0" />
        <title>BlackScreen | Dashboards</title>

        <link rel="stylesheet" href="../css/cssTecnico.css" />
        <link rel="stylesheet" href="./../css/dashboards.css" />
        <link rel="stylesheet" href="./../css/style.css" />

        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
        />
        <script src="../js/sessao.js"></script>
        <script src="./../js/alerta.js"></script>

        <link rel="preconnect" href="https://fonts.gstatic.com" />
        <link
            href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
            rel="stylesheet"
        />

        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""
        />
        <script
            src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""
        ></script>
        <script src="../js/leaflet-heat.js"></script>

        <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    </head>

    <body>
        <div class="janela">
            <div class="header-left">
                <img
                    src="../assets/imgs/blackscreenlogo.png"
                    alt="BlackScreen"
                />
                <div class="hello">
                    <h3>
                        Bem vindo, <br /><span id="b_usuario">usuário</span>!
                    </h3>
                </div>
                <div class="links">
                    <div class="btn-nav">
                        <a href="../dashboard/dashboardTecnico.html"
                            ><span class="material-symbols-outlined">home</span>
                            <h3>Ínicio</h3></a
                        >
                    </div>
                    <div class="btn-nav-white">
                        <a href="../dashboard/logAlertas.html"
                            ><span class="material-symbols-outlined"
                                >notifications</span
                            >
                            <h3>Alertas</h3></a
                        >
                    </div>
                    <div class="btn-nav-white">
                        <a href="./../dashboard/atm.htm"
                            ><span class="material-symbols-outlined"
                                >local_atm</span
                            >
                            <h3>ATMs</h3></a
                        >
                    </div>
                    <div class="btn-nav-white">
                        <a href="../dashboard/cadastroComponentes.html"
                            ><span class="material-symbols-outlined"
                                >health_and_safety</span
                            >
                            <h3>Componentes</h3></a
                        >
                    </div>
                    <div class="btn-nav-white">
                        <a href="./../dashLukas/persona.html"
                            ><span class="material-symbols-outlined"
                                >signal_cellular_alt</span
                            >
                            <h3>Persona</h3></a
                        >
                    </div>
                    <div class="btn-nav-white">
                        <a href="./../dashboard/insight.html"
                            ><span class="material-symbols-outlined"
                                >search_insights</span
                            >
                            <h3>Insights</h3></a
                        >
                    </div>
                    <div class="btn-nav-white">
                        <a href="./../dashboard/perfil.html"
                            ><span class="material-symbols-outlined"
                                >account_circle</span
                            >
                            <h3>Meu Perfil</h3></a
                        >
                    </div>
                </div>
                <div class="btn-logout" onclick="limparSessao()">
                    <h3>Sair</h3>
                </div>
            </div>

            <div class="help-desk content">
                <h1 id="maquinaid">Caixa valor</h1>

                <div class="charts-grid">
                    <div
                        class="container_jira chart-card employees-by-role-bar full-width double-height"
                    >
                        <h3>Informações da máquina</h3>
                        <div class="info-columns">
                            <div class="coluna1">
                                <div class="infosdentro">
                                    <p>Logradouro:</p>
                                    <span id="rua">Aguarde....</span>
                                </div>
                                <div class="infosdentro">
                                    <p>Bairro:</p>
                                    <span id="bairro">Aguarde....</span>
                                </div>
                                <div class="infosdentro">
                                    <p>Cidade:</p>
                                    <span id="cidade">Aguarde....</span>
                                </div>
                                <div class="infosdentro">
                                    <p>Estado:</p>
                                    <span id="estado">Aguarde....</span>
                                </div>
                            </div>
                            <div class="coluna2">
                                <div class="infosdentro">
                                    <p>Disponibilidade:</p>
                                    <span
                                        id="bolinha-disponibilidade"
                                        class="bolinha-alerta"
                                    ></span>
                                    <span id="disponibilidade"
                                        >Aguarde....</span
                                    >
                                    <span
                                        id="helpDisponibilidade"
                                        class="help-icon"
                                        >?</span
                                    >
                                </div>
                                <div class="infosdentro">
                                    <p>Latência:</p>
                                    <span
                                        id="bolinha-latencia"
                                        class="bolinha-alerta"
                                    ></span>
                                    <span id="latencia">Aguarde....</span>
                                    <span id="helpLatencia" class="help-icon"
                                        >?</span
                                    >
                                </div>
                                <div class="infosdentro">
                                    <p>Perda de pacotes:</p>
                                    <span
                                        id="bolinha-pacotes"
                                        class="bolinha-alerta"
                                    ></span>
                                    <span id="pacotes">Aguarde....</span>
                                    <span id="helpPacotes" class="help-icon"
                                        >?</span
                                    >
                                </div>
                                <div class="infosdentro">
                                    <p>Status:</p>
                                    <span
                                        id="bolinha-status"
                                        class="bolinha-alerta"
                                    ></span>
                                    <span id="status">Aguarde....</span>
                                    <span id="helpStatus" class="help-icon"
                                        >?</span
                                    >
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="right-cards">
                        <div
                            class="grafico chart-card container employees-status half-height"
                        >
                            <h3>Data de manutenção recomendada</h3>
                            <div class="chart-container">
                                <div id="myChart"></div>
                            </div>
                        </div>
                        <div
                            class="grafico chart-card container employees-status half-height"
                            id="caixa-jira"
                        >
                            <h3>Último chamado</h3>
                            <div id="ultimoChamado">
                                <div class="keyChamada">Aguarde....</div>
                                <div class="nome">Aguarde....</div>
                                <div class="horario">Aguarde....</div>
                                <div class="status concluido">Aguarde....</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="charts-grid-single">
                    <div
                        class="containerBarra container_jira container chart-card full-width"
                    >
                        <div class="period-selector">
                            <label for="periodSelect"
                                ><strong>Selecionar período:</strong></label
                            >
                            <select id="periodSelect" class="dropdown">
                                <option value="7">7 dias</option>
                                <option value="30">30 dias</option>
                                <option value="90">3 meses</option>
                            </select>
                        </div>
                        <div class="graficos-row">
                            <div style="flex: 1; min-width: 0; height: 100%">
                                <center><h3>Disponibilidade</h3></center>
                                <div id="lineChart1"></div>
                            </div>
                            <div style="flex: 1; min-width: 0; height: 100%">
                                <center><h3>Quantidade de chamados</h3></center>
                                <div id="barChart"></div>
                            </div>
                            <div style="flex: 1; min-width: 0; height: 100%">
                                <center>
                                    <h3>Probabilidade de falha no envio</h3>
                                </center>
                                <div id="lineChart2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="meuModalJira" class="modal-container" style="display: none">
            <div class="modal-content">
                <span class="fechar" onclick="fecharModal()">&times;</span>
                <div id="conteudoModal"></div>
            </div>
        </div>

        <div id="modalAjuda" class="modal-ajuda" style="display: none">
            <div class="modal-ajuda-content">
                <span id="fecharAjuda" class="fechar-ajuda">&times;</span>
                <p id="textoAjuda"></p>
            </div>
        </div>
        <script>
            b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
            const urlparam = new URLSearchParams(window.location.search);
            const mac = urlparam.get("id");
            var nomeEmpresa = "";
            maquinaid.innerHTML = "Caixa #" + urlparam.get("id");

            let valoresMetrica = {
                disponibilidade: 96.6,
                latencia: null,
                perda: null,
                status: null,
            };

            function obterTextoAjuda(tipo) {
                const valores = valoresMetrica;

                switch (tipo) {
                    case "disponibilidade":
                        if (valores.disponibilidade === null)
                            return "Disponibilidade ainda não calculada.";
                        if (valores.disponibilidade > 99)
                            return "A disponibilidade está ótima.";
                        if (valores.disponibilidade > 95)
                            return "A disponibilidade está ok.";
                        return "Disponibilidade baixa. Verifique infraestrutura e chamados recentes.";

                    case "latencia":
                        if (valores.latencia === null)
                            return "Latência ainda não medida.";
                        if (valores.latencia < 150)
                            return "Latência aceitável (0-150ms).";
                        if (valores.latencia < 300)
                            return "Latência média (150-300ms). Pode causar lentidão.";
                        return "Latência alta (>300ms). Investigue a rede.";

                    case "pacotes":
                        if (valores.perda === null)
                            return "Perda de pacotes ainda não calculada.";
                        if (valores.perda < 5)
                            return "Perda baixa. Conexão estável.";
                        if (valores.perda < 20)
                            return "Perda moderada. Pode causar falhas em transações.";
                        return "Perda alta. Alto risco de falha no envio.";

                    case "status":
                        if (valores.status === null)
                            return "Status ainda não disponível.";
                        if (valores.status === "Online")
                            return "Máquina online.";
                        return "Máquina offline.";
                }
            }

            const modalAjuda = document.getElementById("modalAjuda");
            const textoAjuda = document.getElementById("textoAjuda");
            const fecharAjuda = document.getElementById("fecharAjuda");

            document.querySelectorAll(".help-icon").forEach((icon) => {
                icon.addEventListener("click", function () {
                    const tipo = this.id.replace("help", "").toLowerCase();
                    textoAjuda.textContent = obterTextoAjuda(tipo);
                    modalAjuda.style.display = "flex";
                });
            });

            fecharAjuda.addEventListener(
                "click",
                () => (modalAjuda.style.display = "none"),
            );
            window.addEventListener("click", (e) => {
                if (e.target === modalAjuda) modalAjuda.style.display = "none";
            });

            fetch("/caixas/listarinfo", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    mac: mac,
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    console.log(data);
                    maquinaid.innerHTML = "Caixa " + data[0].codigoCaixa;
                    rua.innerHTML = data[0].Logradouro;
                    estado.innerHTML = data[0].UF;
                    cidade.innerHTML = data[0].Cidade;
                    bairro.innerHTML = data[0].Bairro;
                    nomeEmpresa = data[0].Nome_Empresa;
                })
                .catch((error) => {
                    console.error(error);
                });

            fetch("/caixas/buscarchamado", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    mac: mac,
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    const issue = data[0];

                    const key = issue.key;
                    const status = issue.fields.status.name;
                    const summary = issue.fields.summary;

                    const descriptionContent = issue.fields.description.content;
                    let descriptionText = descriptionContent
                        .map((paragraph) =>
                            paragraph.content.map((node) => node.text).join(""),
                        )
                        .join("\n");

                    const statusClasse =
                        status.toLowerCase() === "concluído"
                            ? "concluido"
                            : "outro";

                    const createdDate = new Date(
                        issue.fields.created,
                    ).toLocaleString("pt-BR");

                    document.getElementById("caixa-jira").innerHTML = `
                      <h3>Último chamado</h3>
                      <a href="https://chamadosblackscreen.atlassian.net/browse/${key}">
                      <div id="ultimoChamado">
                        <div class="keyChamada">${key}</div>
                        <div class="nome">${summary}</div>
                        <div class="horario">${createdDate}</div>
                        <div class="status ${statusClasse}">${status}</div>
                      </div> </a>


                      `;
                })
                .catch((error) => {
                    console.error(error);
                });

            fetch("/caixas/ping", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    valoresMetrica.latencia = data.latencia;
                    valoresMetrica.perda = data.perda;
                    if (valoresMetrica.perda < 100) {
                        if (valoresMetrica.perda >= 20) {
                            document
                                .getElementById("bolinha-pacotes")
                                .classList.replace(
                                    "bolinha-alerta",
                                    "bolinha-critico",
                                );
                        } else if (valoresMetrica.perda < 5) {
                            document
                                .getElementById("bolinha-pacotes")
                                .classList.replace(
                                    "bolinha-alerta",
                                    "bolinha-ok",
                                );
                        }
                        document.getElementById("status").innerHTML = "Online";
                        valoresMetrica.status = "Online";
                        document
                            .getElementById("bolinha-status")
                            .classList.replace("bolinha-alerta", "bolinha-ok");
                    } else {
                        document.getElementById("status").innerHTML = "Offline";
                        valoresMetrica.status = "Offline";
                        document
                            .getElementById("bolinha-status")
                            .classList.replace(
                                "bolinha-alerta",
                                "bolinha-critico",
                            );
                        document
                            .getElementById("bolinha-pacotes")
                            .classList.replace(
                                "bolinha-alerta",
                                "bolinha-critico",
                            );
                    }
                    if (valoresMetrica.latencia <= 150) {
                        document
                            .getElementById("bolinha-latencia")
                            .classList.replace("bolinha-alerta", "bolinha-ok");
                    } else if (valoresMetrica.latencia > 300) {
                        document
                            .getElementById("bolinha-latencia")
                            .classList.replace(
                                "bolinha-alerta",
                                "bolinha-critico",
                            );
                    }

                    document.getElementById("pacotes").innerHTML =
                        `${valoresMetrica.perda}%`;
                    document.getElementById("latencia").innerHTML =
                        `${valoresMetrica.latencia}ms`;
                })
                .catch((error) => {
                    console.error(error);
                });

            const optionsLine1 = {
                chart: {
                    type: "line",
                    height: 300,
                    toolbar: { show: false },
                },
                series: [
                    {
                        name: "Série 1",
                        data: [10, 41, 35, 51, 49, 62, 69],
                        color: "#004076",
                    },
                ],
                stroke: {
                    curve: "smooth",
                    width: 3,
                },
                xaxis: {
                    categories: [
                        "Jan",
                        "Feb",
                        "Mar",
                        "Apr",
                        "May",
                        "Jun",
                        "Jul",
                    ],
                    title: { text: "Meses" },
                },
                yaxis: {
                    title: { text: "Quantidade" },
                },
            };

            const optionsBar = {
                chart: {
                    type: "bar",
                    height: 300,
                    toolbar: { show: false },
                },
                series: [
                    {
                        name: "Série 2",
                        data: [23, 12, 54, 61, 32, 56, 81],
                        color: "#004076",
                    },
                ],
                xaxis: {
                    categories: [
                        "Jan",
                        "Feb",
                        "Mar",
                        "Apr",
                        "May",
                        "Jun",
                        "Jul",
                    ],
                    title: { text: "Meses" },
                },
                yaxis: {
                    title: { text: "Volume" },
                },
            };

            const optionsLine2 = {
                chart: {
                    type: "line",
                    height: 300,
                    toolbar: { show: false },
                },
                series: [
                    {
                        name: "Série 3",
                        data: [30, 20, 60, 40, 70, 50, 90],
                        color: "#004076",
                    },
                ],
                stroke: {
                    curve: "smooth",
                    width: 3,
                },
                xaxis: {
                    categories: [
                        "Jan",
                        "Feb",
                        "Mar",
                        "Apr",
                        "May",
                        "Jun",
                        "Jul",
                    ],
                    title: { text: "Meses" },
                },
                yaxis: {
                    title: { text: "Tendência" },
                },
            };

            const lineChart1 = new ApexCharts(
                document.querySelector("#lineChart1"),
                optionsLine1,
            );
            const barChart = new ApexCharts(
                document.querySelector("#barChart"),
                optionsBar,
            );
            const lineChart2 = new ApexCharts(
                document.querySelector("#lineChart2"),
                optionsLine2,
            );

            lineChart1.render();
            barChart.render();
            lineChart2.render();
        </script>
    </body>
</html>
